# Food abundance at temperate shores can mitigate Arctic climate change effects in a migratory bird
-----
**_Eldar Rakhimberdiev_**

Parts of this code take time to run, so if you want to go through examples fast you can specify
```{r}
Run_everything=FALSE # Change it to TRUE if you want run everything on you system
```
## 1. Reconstruction of snow melt from remote sensing data
We used NOAA CDR snow cover extent based on remote sensed data [Brown & Robinson 2011](#brown-robinson). Weekly snow cover data were downloaded on 24×24 km grid and subset by the _limosa lapponica taimyrensis_ breeding range [Lappo et al. 2012](#lappo). Following code provided in [van Gils et al 2016](#van-gils), we extracted date 50% spring snow coverage as linearly interpolated time point at which mean snow cover first time in a year crossed 50%, results are presented in Extended Data Tab. 1.
### 1.1 Download publically available data
load required packages
```{r}
library(ncdf4)
library(raster)
library(rgdal)
library(maptools)
```
Download taimyrensis bar-trailed godwit [(_Limosa lapponica taimyrensis_) range](#lappo) from this GitHub repo
```{r}
area.longlat<-readRDS(gzcon(url('https://git.io/vXRBz')))
```
Download and read in R all [snow data from NOAA](#brown-robinson)
```{r} 
download.file('ftp://data.ncdc.noaa.gov/cdr/snowcover/nhsce_v01r01_19661004_20160905.nc',
               destfile='snow.nc', method="internal", mode="wb")
dat <- nc_open('snow.nc')
t <- ncvar_get(dat,'time') ## "days since 1966-10-03"
z <- ncvar_get(dat,'snow_cover_extent')
ylat <- ncvar_get(dat,'latitude')
xlon <- ncvar_get(dat,'longitude')

nc_close(dat)
```
### 1.2 Projection and raster extent
```{r}
lon <- raster(xlon)
lat <- raster(ylat)
snow <- brick(z)

start <- as.POSIXct("1966-10-03", "GMT")
  date <- start + ((t-6)*24*60*60)
```
### 1.3 Projection
```{r}
#projSnow <- "+proj=longlat"
projSnow <- "+proj=stere +lat_0=90 +lon_0=10"
xy <- project(cbind(values(lon), values(lat)), projSnow)
area <- spTransform(area.longlat, CRS(projSnow))
```
### 1.4 Rasterize
```{r}
r <- raster(xmn = min(xy[,1]), xmx = max(xy[,1]), ymn = min(xy[,2]),
            ymx = max(xy[,2]), nrow=88, ncol=88)
tmp <- rasterize(xy, y = r, field = values(snow[[1]]))
plot(tmp)
data(wrld_simpl)
wrld <- spTransform(subset(wrld_simpl, NAME != "Antarctica"), CRS(projSnow))
plot(as(wrld, "SpatialLines"), add = TRUE, col = "red")

out <- data.frame(Date = date, Z = NA)
if (Run_everything) {
   # following loop takes ~ 20 minutes brt
   for(i in 1982:2016) {
      cat(round(i/length(names(snow)),4), "%   ", "\r")
      for(w in 1:length(date[as.numeric(format(date, "%Y"))==i])) {
         ind <- which(as.numeric(format(date, "%Y"))==i)[w]  
         tmp1 <- rasterize(xy, y = tmp, field = values(snow[[ind]]))
         tmp2 <- crop(tmp1, area) 
         tmp3 <- resample(tmp2, 
                      raster(extent(tmp2), ncol = 6, nrow = 12),
                      method = "ngb")
         out[ind,2] <- extract(tmp3, area, mean, na.rm=TRUE)
        }
   }
   #save(out, file = "snow.RData")
} else {
   load(url("https://git.io/vXEnX"))
}
```
### 1.5 Extract first date of 50% snow melt
```{r}
out$zz<-out$Z-0.5
plot(Z~Date, data=subset(out, !is.na(Z)), type='l')
Index<-which(out$zz[-1]*out$zz[-length(out$zz)]<=0 & out$zz[-length(out$zz)]>=0)
Years_tmp<-unique(as.numeric(format(out$Date[Index], '%Y')))
#dates with last measurement
Dates_last<-as.POSIXct(sapply(Years_tmp, FUN=function(x) 
            out$Date[Index][as.numeric(format(out$Date[Index], "%Y")) == x ] [1]), origin='1970-01-01')
Index_last<-sapply(Years_tmp, FUN=function(x) 
            Index[as.numeric(format(out$Date[Index], "%Y")) == x ] [1])
Weight_second<-(out$Z[Index_last]-0.5)/(out$Z[Index_last] - out$Z[Index_last+1])
Weight_first<-1-Weight_second
Weighted_dates<-as.POSIXct(as.numeric(out$Date[Index_last])*Weight_first +
                as.numeric(out$Date[Index_last+1])*Weight_second, origin='1970-01-01')
Res<-data.frame(Year=Years_tmp, Date50=Weighted_dates)
Res$jdate50<-as.numeric(format(Res$Date50, '%j'))
plot(jdate50~Year, data=subset(Res))
summary(lm(jdate50~Year, data=subset(Res, Year>1995)))
Snow50<-Res
write.csv(Snow50, file='Snow50.RData', row.names=FALSE)
```
## 2. Arrival dates from citizen science data
We used data from citizen science project www.trektellen.nl and modelled them with approach similar to one used in Lindén & Mäntyniemi ([2011](#lindén-mäntyniemi)). Model was estimated with JAGS sampler ([Plummer 2003](#plummer)) via R2jags ([Su & Yahima 2015](#su-yahima)) interface from R.
_TO run code from this chapter you need to install JAGS software_
### 2.1 Load packages and data
```{r}
library(R2jags)
sites_years_dates<-read.csv('https://git.io/vXEBH', as.is=TRUE)
```
### 2.2 Formulate model in JAGS language
```{r}
sink("migration_model.jags") 
cat("
model {
    # Model
    for (Obs in 1:nObs) {    
      log(N[Obs])<-a0 + total_k[Year[Obs]] +
	  site_i[Site[Obs]]+Offset[Obs]-((Date[Obs]-
	  T_0k[Year[Obs]])^2)/(2*sigma[Year[Obs]]^2)-
	  0.9189385-log(sigma[Year[Obs]])
    }	
    #Priors
    for (k in 1:nYears) {
       total_k_src[k] ~ dnorm(0, 0.10)#T(0,)
       T_0k[k]~dnorm(125, 0.1)
       sigma[k]~dnorm(2, 0.1)T(0,)
    }
    for (i in 1:nSites) {
      site_i_src[i] ~ dnorm(0, 0.10) 
    }
    site_i  <- site_i_src[] -mean(site_i_src[])
    total_k <- total_k_src[]-mean(total_k_src[])
    a0 ~ dnorm(6, 0.1)
    r ~ dgamma(0.01,0.01)
    for (Obs in 1:nObs) { 
      p[Obs]<- r/(r+N[Obs])
    }
    #Likelihood
    for (Obs in 1:nObs) {
       Y[Obs]~dnegbin( p[Obs] , r )
    }
}",fill = TRUE)
sink()
```
### 2.3 Prepare data and inits
```{r}
Data<-list('nObs'=nrow(sites_years_dates),
           'nYears'=length(unique(sites_years_dates$Year)),
           'nSites'=length(unique(sites_years_dates$Site)),
           'Year'=as.numeric(as.factor(sites_years_dates$Year)),
           'Site'=as.numeric(as.factor(sites_years_dates$Site)),
           'Date'=sites_years_dates$yday,
           'Offset'=log(sites_years_dates$Duration),
           'Y'=sites_years_dates$north)
nSites=length(unique(sites_years_dates$Site))
nYears=length(unique(sites_years_dates$Year))
inits=function() {list(
           'a0' =runif(1,3,10),
           'total_k_src'=rnorm(nYears, 0, 1), 
           'T_0k'=rnorm(nYears, 125, 2),
           'site_i_src'=log(plogis(rnorm(nSites, 0, 0.5))),
           'sigma'=rnorm(nYears, 8, 2))
}
jags.params=c("a0","total_k", "T_0k", "site_i", "sigma", "r")
```
### 2.4 Run the model
```{r}
if (Run_everything) {
   # following run takes ~ 5 minutes brt
   nchains<-parallel::detectCores()-1
   migration_model<-jags.parallel(data=Data, 
                  inits, 
                  parameters=jags.params, 
                  "migration_model.jags", 
                  n.chains = nchains, 
                  n.thin   = 3, 
                  n.iter   = 500, 
                  n.burnin = 200, 
                  working.directory = getwd())
   print(migration_model)
   save(migration_model, file="migration_model.RData")
} else {
load(url('https://git.io/vXE0v'))
}
```
### 2.5 Look at the output
```{r}
print(migration_model)
Arrivals<-data.frame(Yr=unique(sites_years_dates$Year_real), arrival=migration_model$BUGSoutput$mean$T_0k, sigma=migration_model$BUGSoutput$mean$sigma)
write.csv(Arrivals, file="Arrivals_migration_model.csv", row.names=F)
```
### 3 



## References

1. Brown, R. D. & Robinson, D. A. Northern Hemisphere spring snow cover variability and change over 1922–2010 including an assessment of uncertainty. The Cryosphere 5, 219–229 (2011).<a id="brown-robinson"></a>
1. Lappo, E., Tomkovich, P. & Syroechkovskiy, E. Atlas of breeding waders in the Russian Arctic. (2012).<a id="lappo"></a>
1. van Gils, J. A. et al. Body shrinkage due to Arctic warming reduces red knot fitness in tropical wintering range. Science 352, 819–821 (2016).<a id="van-gils"></a>
1. Lindén, A. & Mäntyniemi, S. Using the negative binomial distribution to model overdispersion in ecological count data. Ecology 92, 1414–1421 (2011).<a id="lindén-mäntyniemi"></a>
1. Plummer, M. JAGS: A program for analysis of Bayesian graphical models using Gibbs sampling. (2003).<a id="plummer"></a>
1. Su, Y.-S. & Masanao Yajima. R2jags: Using R to Run ‘JAGS’. (2015).<a id="su-yahima"></a>
