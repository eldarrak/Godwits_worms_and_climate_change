# Food abundance at temperate shores can mitigate Arctic climate change effects in a migratory bird
-----
**_Eldar Rakhimberdiev_**

Parts of this code take time to run, so if you want to go through examples fast you can specify
```{r}
Run_everything=FALSE # Change it to TRUE if you want run everything on you system
```
## 1. Reconstruction of snow melt from remote sensing data
We used NOAA CDR snow cover extent based on remote sensed data [Brown & Robinson 2011](#brown-robinson). Weekly snow cover data were downloaded on 24×24 km grid and subset by the _limosa lapponica taimyrensis_ breeding range [Lappo et al. 2012](#lappo). Following code provided in [van Gils et al 2016](#van-gils), we extracted date 50% spring snow coverage as linearly interpolated time point at which mean snow cover first time in a year crossed 50%, results are presented in Extended Data Tab. 1.
### 1.1 Download publically available data
load required packages
```{r}
library(ncdf4)
library(raster)
library(rgdal)
library(maptools)
```
Download taimyrensis bar-trailed godwit [(_Limosa lapponica taimyrensis_) range](#lappo) from this GitHub repo
```{r}
area.longlat<-readRDS(gzcon(url('https://git.io/vXRBz')))
```
Download and read in R all [snow data from NOAA](#brown-robinson)
```{r} 
download.file('ftp://data.ncdc.noaa.gov/cdr/snowcover/nhsce_v01r01_19661004_20160905.nc',
               destfile='snow.nc', method="internal", mode="wb")
dat <- nc_open('snow.nc')
t <- ncvar_get(dat,'time') ## "days since 1966-10-03"
z <- ncvar_get(dat,'snow_cover_extent')
ylat <- ncvar_get(dat,'latitude')
xlon <- ncvar_get(dat,'longitude')

nc_close(dat)
```
### 1.2 Projection and raster extent
```{r}
lon <- raster(xlon)
lat <- raster(ylat)
snow <- brick(z)

start <- as.POSIXct("1966-10-03", "GMT")
  date <- start + ((t-6)*24*60*60)
```
### 1.3 Projection
```{r}
#projSnow <- "+proj=longlat"
projSnow <- "+proj=stere +lat_0=90 +lon_0=10"
xy <- project(cbind(values(lon), values(lat)), projSnow)
area <- spTransform(area.longlat, CRS(projSnow))
```
### 1.4 Rasterize
```{r}
r <- raster(xmn = min(xy[,1]), xmx = max(xy[,1]), ymn = min(xy[,2]),
            ymx = max(xy[,2]), nrow=88, ncol=88)
tmp <- rasterize(xy, y = r, field = values(snow[[1]]))

plot(tmp)
data(wrld_simpl)
wrld <- spTransform(subset(wrld_simpl, NAME != "Antarctica"), CRS(projSnow))
plot(as(wrld, "SpatialLines"), add = TRUE, col = "red")

out <- data.frame(Date = date, Z = NA)
# following loop takes ~ 20 minutes brt
if (Run_everything) {
   for(i in 1982:2016) {
      cat(round(i/length(names(snow)),4), "%   ", "\r")
      for(w in 1:length(date[as.numeric(format(date, "%Y"))==i])) {
         ind <- which(as.numeric(format(date, "%Y"))==i)[w]  
         tmp1 <- rasterize(xy, y = tmp, field = values(snow[[ind]]))
         tmp2 <- crop(tmp1, area) 
         tmp3 <- resample(tmp2, 
                      raster(extent(tmp2), ncol = 6, nrow = 12),
                      method = "ngb")
         out[ind,2] <- extract(tmp3, area, mean, na.rm=TRUE)
        }
   }
   #save(out, file = "snow.RData")
} else {
   load(url("https://git.io/vXEnX"))
   }
```
### 1.5 Extract first date of 50% snow melt
```{r}
out$zz<-out$Z-0.5
plot(Z~Date, data=subset(out, !is.na(Z)), type='l')
Index<-which(out$zz[-1]*out$zz[-length(out$zz)]<=0 & out$zz[-length(out$zz)]>=0)
Years_tmp<-unique(as.numeric(format(out$Date[Index], '%Y')))
#dates with last measurement
Dates_last<-as.POSIXct(sapply(Years_tmp, FUN=function(x) 
            out$Date[Index][as.numeric(format(out$Date[Index], "%Y")) == x ] [1]), origin='1970-01-01')
Index_last<-sapply(Years_tmp, FUN=function(x) 
            Index[as.numeric(format(out$Date[Index], "%Y")) == x ] [1])
Weight_second<-(out$Z[Index_last]-0.5)/(out$Z[Index_last] - out$Z[Index_last+1])
Weight_first<-1-Weight_second
Weighted_dates<-as.POSIXct(as.numeric(out$Date[Index_last])*Weight_first +
                as.numeric(out$Date[Index_last+1])*Weight_second, origin='1970-01-01')
Res<-data.frame(Year=Years_tmp, Date50=Weighted_dates)
Res$jdate50<-as.numeric(format(Res$Date50, '%j'))
plot(jdate50~Year, data=subset(Res))
summary(lm(jdate50~Year, data=subset(Res, Year>1995)))
Snow50<-Res
write.csv(Snow50, file='Snow50.RData', row.names=FALSE)
```



## References

1. Brown, R. D. & Robinson, D. A. Northern Hemisphere spring snow cover variability and change over 1922–2010 including an assessment of uncertainty. The Cryosphere 5, 219–229 (2011).<a id="brown-robinson"></a>
1. Lappo, E., Tomkovich, P. & Syroechkovskiy, E. Atlas of breeding waders in the Russian Arctic. (2012).<a id="lappo"></a>
1. van Gils, J. A. et al. Body shrinkage due to Arctic warming reduces red knot fitness in tropical wintering range. Science 352, 819–821 (2016).<a id="van-gils"></a>
