# Food abundance at temperate shores can mitigate Arctic climate change effects in a migratory bird
-----
**_Eldar Rakhimberdiev_**

Parts of this code take time to run, so if you want to go through examples fast you can specify
```{r}
Run_everything=FALSE # Change it to TRUE if you want run everything on you system
```
## 1. Reconstruction of snow melt from remote sensing data
We used NOAA CDR snow cover extent based on remote sensed data [Brown & Robinson 2011](#brown-robinson). Weekly snow cover data were downloaded on 24×24 km grid and subset by the _limosa lapponica taimyrensis_ breeding range [Lappo et al. 2012](#lappo). Following code provided in [van Gils et al 2016](#van-gils), we extracted date 50% spring snow coverage as linearly interpolated time point at which mean snow cover first time in a year crossed 50%, results are presented in Extended Data Tab. 1.
### 1.1 Download publically available data
load required packages
```{r}
library(ncdf4)
library(raster)
library(rgdal)
library(maptools)
```
Download taimyrensis bar-trailed godwit [(_Limosa lapponica taimyrensis_) range](#lappo) from this GitHub repo
```{r}
area.longlat<-readRDS(gzcon(url('https://git.io/vXRBz')))
```
Download and read in R all [snow data from NOAA](#brown-robinson)
```{r} 
download.file('ftp://data.ncdc.noaa.gov/cdr/snowcover/nhsce_v01r01_19661004_20160905.nc',
               destfile='snow.nc', method="internal", mode="wb")
dat <- nc_open('snow.nc')
t <- ncvar_get(dat,'time') ## "days since 1966-10-03"
z <- ncvar_get(dat,'snow_cover_extent')
ylat <- ncvar_get(dat,'latitude')
xlon <- ncvar_get(dat,'longitude')

nc_close(dat)
```
### 1.2 Projection and raster extent
```{r}
lon <- raster(xlon)
lat <- raster(ylat)
snow <- brick(z)

start <- as.POSIXct("1966-10-03", "GMT")
  date <- start + ((t-6)*24*60*60)
```
### 1.3 Projection
```{r}
projSnow <- "+proj=stere +lat_0=90 +lon_0=10"
xy <- project(cbind(values(lon), values(lat)), projSnow)
area <- spTransform(area.longlat, CRS(projSnow))
```
### 1.4 Rasterize
```{r}
r <- raster(xmn = min(xy[,1]), xmx = max(xy[,1]), ymn = min(xy[,2]),
            ymx = max(xy[,2]), nrow=88, ncol=88)
tmp <- rasterize(xy, y = r, field = values(snow[[1]]))
plot(tmp)
data(wrld_simpl)
wrld <- spTransform(subset(wrld_simpl, NAME != "Antarctica"), CRS(projSnow))
plot(as(wrld, "SpatialLines"), add = TRUE, col = "red")

out <- data.frame(Date = date, Z = NA)
if (Run_everything) {
   # following loop takes ~ 20 minutes brt
   for(i in 1982:2016) {
      cat(round(i/length(names(snow)),4), "%   ", "\r")
      for(w in 1:length(date[as.numeric(format(date, "%Y"))==i])) {
         ind <- which(as.numeric(format(date, "%Y"))==i)[w]  
         tmp1 <- rasterize(xy, y = tmp, field = values(snow[[ind]]))
         tmp2 <- crop(tmp1, area) 
         tmp3 <- resample(tmp2, 
                      raster(extent(tmp2), ncol = 6, nrow = 12),
                      method = "ngb")
         out[ind,2] <- extract(tmp3, area, mean, na.rm=TRUE)
        }
   }
   #save(out, file = "snow.RData")
} else {
   load(url("https://git.io/vXEnX"))
}
```
### 1.5 Extract first date of 50% snow melt
```{r}
out$zz<-out$Z-0.5
plot(Z~Date, data=subset(out, !is.na(Z)), type='l')
Index<-which(out$zz[-1]*out$zz[-length(out$zz)]<=0 & out$zz[-length(out$zz)]>=0)
Years_tmp<-unique(as.numeric(format(out$Date[Index], '%Y')))
#dates with last measurement
Dates_last<-as.POSIXct(sapply(Years_tmp, FUN=function(x) 
            out$Date[Index][as.numeric(format(out$Date[Index], "%Y")) == x ] [1]), origin='1970-01-01')
Index_last<-sapply(Years_tmp, FUN=function(x) 
            Index[as.numeric(format(out$Date[Index], "%Y")) == x ] [1])
Weight_second<-(out$Z[Index_last]-0.5)/(out$Z[Index_last] - out$Z[Index_last+1])
Weight_first<-1-Weight_second
Weighted_dates<-as.POSIXct(as.numeric(out$Date[Index_last])*Weight_first +
                as.numeric(out$Date[Index_last+1])*Weight_second, origin='1970-01-01')
Res<-data.frame(Year=Years_tmp, Date50=Weighted_dates)
Res$jdate50<-as.numeric(format(Res$Date50, '%j'))
plot(jdate50~Year, data=subset(Res))
summary(lm(jdate50~Year, data=subset(Res, Year>1995)))
Snow50<-Res
write.csv(Snow50, file='Snow50.RData', row.names=FALSE)
```
## 2. Arrival dates from citizen science data
We used data from citizen science project www.trektellen.nl and modelled them with approach similar to one used in Lindén & Mäntyniemi ([2011](#lindén-mäntyniemi)). Model was estimated with JAGS sampler ([Plummer 2003](#plummer)) via R2jags ([Su & Yahima 2015](#su-yahima)) interface from R.
_TO run code from this chapter you need to install JAGS software_
### 2.1 Load packages and data
```{r}
library(R2jags)
sites_years_dates<-read.csv('https://git.io/vXEBH', as.is=TRUE)
```
### 2.2 Formulate model in JAGS language
```{r}
sink("migration_model.jags") 
cat("
model {
    # Model
    for (Obs in 1:nObs) {    
      log(N[Obs])<-a0 + total_k[Year[Obs]] +
	  site_i[Site[Obs]]+Offset[Obs]-((Date[Obs]-
	  T_0k[Year[Obs]])^2)/(2*sigma[Year[Obs]]^2)-
	  0.9189385-log(sigma[Year[Obs]])
    }	
    #Priors
    for (k in 1:nYears) {
       total_k_src[k] ~ dnorm(0, 0.10)
       T_0k[k]~dnorm(125, 0.1)
       sigma[k]~dnorm(2, 0.1)T(0,)
    }
    for (i in 1:nSites) {
      site_i_src[i] ~ dnorm(0, 0.10) 
    }
    site_i  <- site_i_src[] -mean(site_i_src[])
    total_k <- total_k_src[]-mean(total_k_src[])
    a0 ~ dnorm(6, 0.1)
    r ~ dgamma(0.01,0.01)
    for (Obs in 1:nObs) { 
      p[Obs]<- r/(r+N[Obs])
    }
    #Likelihood
    for (Obs in 1:nObs) {
       Y[Obs]~dnegbin( p[Obs] , r )
    }
}",fill = TRUE)
sink()
```
### 2.3 Prepare data and inits
```{r}
Data<-list('nObs'=nrow(sites_years_dates),
           'nYears'=length(unique(sites_years_dates$Year)),
           'nSites'=length(unique(sites_years_dates$Site)),
           'Year'=as.numeric(as.factor(sites_years_dates$Year)),
           'Site'=as.numeric(as.factor(sites_years_dates$Site)),
           'Date'=sites_years_dates$yday,
           'Offset'=log(sites_years_dates$Duration),
           'Y'=sites_years_dates$north)
nSites=length(unique(sites_years_dates$Site))
nYears=length(unique(sites_years_dates$Year))
inits=function() {list(
           'a0' =runif(1,3,10),
           'total_k_src'=rnorm(nYears, 0, 1), 
           'T_0k'=rnorm(nYears, 125, 2),
           'site_i_src'=log(plogis(rnorm(nSites, 0, 0.5))),
           'sigma'=rnorm(nYears, 8, 2))
}
jags.params=c("a0","total_k", "T_0k", "site_i", "sigma", "r")
```
### 2.4 Run the model
```{r}
if (Run_everything) {
   # following run takes ~ 5 minutes brt
   nchains<-parallel::detectCores()-1
   migration_model<-jags.parallel(data=Data, 
                  inits, 
                  parameters=jags.params, 
                  "migration_model.jags", 
                  n.chains = nchains, 
                  n.thin   = 3, 
                  n.iter   = 500, 
                  n.burnin = 200, 
                  working.directory = getwd())
   print(migration_model)
   save(migration_model, file="migration_model.RData")
} else {
load(url('https://git.io/vXE0v'))
}
```
### 2.5 Look at the output
```{r}
print(migration_model)
Arrivals<-data.frame(Yr=unique(sites_years_dates$Year_real), 
                     arrival=migration_model$BUGSoutput$mean$T_0k,
                     sigma=migration_model$BUGSoutput$mean$sigma)
write.csv(Arrivals, file="Arrivals_migration_model.csv", row.names=F)
```
## 3 Fuelling rates and their relationship with lugworm abundance
### 3.1 Estimate yearly arrival weights from Castricum data
```{r}
library(lme4)
Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
Capture_data$date<-as.Date(Capture_data$date)

# arrival weight females
aggr_data_females<-subset(Capture_data, Sex==2 & Site == "Castricum")
Arrival_weight_females<-aggregate(aggr_data_females$Mass, 
                         by=list(aggr_data_females$Yr), FUN=mean)
names(Arrival_weight_females)  <-c("Yr", "Arr_Weight")
aggr_data_females$fYr<-as.factor(aggr_data_females$Yr)
weight_model_females<-lmer(Mass~-1+(1|fYr), data=aggr_data_females)
mu_W0_females<-coef(weight_model_females)$fYr[,1]
sigma2_W0_females<-var(residuals(weight_model_females))

# arrival weight males
aggr_data_males<-subset(Capture_data,  Sex==1 & Site == "Castricum")
Arrival_weight_males<-aggregate(aggr_data_males$Mass,
                         by=list(aggr_data_males$Yr), FUN=mean)
names(Arrival_weight_males)  <-c("Yr", "Arr_Weight")
aggr_data_males$fYr<-as.factor(aggr_data_males$Yr)
weight_model_males<-lmer(Mass~-1+(1|fYr), data=aggr_data_males)
mu_W0_males<-coef(weight_model_males)$fYr[,1]
sigma2_W0_males<-var(residuals(weight_model_males)) 

Arrival_weights<-data.frame(Yr=as.numeric(levels(aggr_data_females$fYr)),
                            Male_arrival_weight=mu_W0_males,
			    Female_arrival_weight=mu_W0_females)
write.csv(Arrival_weights, file='Arrival_weights.csv', row.names=FALSE)
```

### 3.2 load packages and data
Here we load **arrival time** estimated in 2.5 data on lugworm densities in the Dutch Wadden Sea.
```{r}
library(R2jags)
Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
Capture_data$date<-as.Date(Capture_data$date)
Arrivals<-read.csv("https://git.io/vXED0")
names(Arrivals)[2]<-"arrival_day"
Data_to_model<-merge(subset(Capture_data, Site!='Castricum'), Arrivals)
mu_T0<-Arrivals$arrival[Arrivals$Yr %in% unique(Data_to_model$Yr)]
sigma2_T0<-(Arrivals$sigma^2)[Arrivals$Yr %in% unique(Data_to_model$Yr)]

# Lugworms
Lugworms<-read.csv('https://git.io/vXESR')
Lugworms_vec<-Lugworms[Lugworms$Year %in% unique(Data_to_model$Yr),2]

```
### 3.3 Formulate model
```{r}
sink("fuelling_model.jags")

cat("
    model {
    # prior
    for (i in 1:N) {    
       T0[i] ~ dnorm(mu_T0[i2k[i]], tau_T0[i2k[i], i2s[i]])
    }

    # Michaelins - Menten or functional response type II equation for fuelling on lugworms
    for(k in 1:K) {
       Alpha_t[k,1] ~ dnorm(((11*Lugworms[k])/(K_sat_m+Lugworms[k])),
	                         1/sigma2_alpha)
       Alpha_t[k,2] ~ dnorm(((13.2*Lugworms[k])/(K_sat_f+Lugworms[k])),
                             1/sigma2_alpha_fem)
    # 11 for males and 13.2 for females are fuelling maximum rates measured by Prokosch
	}

    # Likelihood
    for (i in 1:N) {
       Wt_mu[i] <- mu_W0[i2k[i],i2s[i]]+(Time[i]-T0[i])*(Alpha_t[i2k[i], i2s[i]])
       Wt[i] ~ dnorm(Wt_mu[i],Wt_tau[i2k[i], i2s[i]])
    }
  
    # params an hyper-priors
    for (k in 1:K) {
       for (s in 1:2) {
          Wt_s2[k,s] <- sigma2_W0[s]
          Wt_tau[k,s]<-1/Wt_s2[k,s]
       }
    }
    sigma2_alpha~dunif(0, 5)  
    sigma2_alpha_fem~dunif(0, 5)  
  
    K_sat_m~dunif(1, 20)
    K_sat_f~dunif(1, 20)
    
    for(k in 1:K) {
       tau_T0[k,1]<-1/(sigma2_T0[k]+sigma2_W0[1]/Alpha_t[k,1]) 
       tau_T0[k,2]<-1/(sigma2_T0[k]+sigma2_W0[2]/Alpha_t[k,2])
    }
}",fill = TRUE)
sink()
```
### 3.4 Prepare data and inits
```{r}
Data=list(Wt=Data_to_model$Mass, Time=Data_to_model$yday,
          i2k=as.numeric(as.factor(Data_to_model$Yr)),
          i2s=Data_to_model$Sex, N=length(Data_to_model$Mass), 
	  K=length(unique(Data_to_model$Yr)),
	  mu_W0=cbind(mu_W0_males, mu_W0_females), 
	  sigma2_W0=c(sigma2_W0_males, sigma2_W0_females),
	  mu_T0=mu_T0,
	  sigma2_T0=sigma2_T0, Lugworms=Lugworms_vec)

inits=function() {
   list(sigma2_alpha=runif(1, 0, 5),
   sigma2_alpha_fem=runif(1, 0, 5),
   K_sat_m=runif(1, 1, 13),
   K_sat_f=runif(1, 1, 13))
}
jags.params=c("Alpha_t", "sigma2_alpha", "sigma2_alpha_fem", "K_sat_m", "K_sat_f")
```
### 3.5 Run the model
```{r}
if (Run_everything) {
   # following run takes ~ 5 minutes brt
   fuelling_model<- jags(data=Data, inits, parameters=jags.params,
                    "fuelling_model.jags", n.chains = 2, n.thin = 10,
		    n.iter = 10000, n.burnin = 1000, working.directory = getwd())
save(fuelling_model, file='fuelling_model.RData')
} else {
load(url('https://git.io/vXEQu'))
}
```
### 3.6 Explore and save model results
```{r}
print(fuelling_model)
Years<-unique(as.numeric((Data_to_model$Yr)))
# save estimated slopes for survival model
Fuelling_slopes<-data.frame(Yr=Years,
         Fuelling_slope_males=fuelling_model$BUGSoutput$mean$Alpha_t[,1],
         Fuelling_slope_females=fuelling_model$BUGSoutput$mean$Alpha_t[,2],
         Fuelling_slope_males_predicted=11*Lugworms_vec/(fuelling_model$BUGSoutput$mean$K_sat_m+Lugworms_vec),
         Fuelling_slope_females_predicted=13.4*Lugworms_vec/(fuelling_model$BUGSoutput$mean$K_sat_f+Lugworms_vec))
write.csv(Fuelling_slopes, file='Fuelling_slopes.csv', row.names=FALSE)
```
### 3.7 Plot estimated fuelling slopes by lugworm abundance
```{r}
time_scales<-abs(1-(Years-(min(Years)-1))/(max((Years-(min(Years)-1))+1)))
MyColor_palette<-colorRampPalette(c('#FC8D62', 'white'))
My_colors<-MyColor_palette(100)

# first we make a plot and second save it as pdf.
par(mfrow=c(1,2))
#-----------------------------
# males plot
plot(fuelling_model$BUGSoutput$mean$Alpha_t[,1]~Lugworms_vec,
     ylim=c(3.5,8.5),  ylab='fueling rate (g per day)',
     xlab='lugworm density, ind. per sq.m', main='Males',  las=1, type='n')
XX<-seq(min(Lugworms_vec), max(Lugworms_vec), 0.1)
Y_m<- t(sapply(XX, FUN=function(x) 
              quantile(x*11 /(x+fuelling_model$BUGSoutput$sims.list$K_sat_m),
	      probs=c(0.025, 0.5,0.975))))
lines(Y_m[,1]~XX, lty=2)
lines(Y_m[,2]~XX, lwd=2)
lines(Y_m[,3]~XX, lty=2)
for (i in 1:length(Lugworms_vec)) {
   points(fuelling_model$BUGSoutput$mean$Alpha_t[i,1]~Lugworms_vec[i],
   pch=21, cex=4, bg=My_colors[round(time_scales*100)][i], lwd=2)
   text(fuelling_model$BUGSoutput$mean$Alpha_t[i,1]~Lugworms_vec[i],
   labels = substr(Years[i],3,4))
}
box()
#-----------------
# females plot
plot(fuelling_model$BUGSoutput$mean$Alpha_t[,2]~Lugworms_vec,
     ylim=c(3.5,8.5),ylab='fueling rate (g per day)',
     xlab='lugworm density, ind. per sq.m', main='Females' ,las=1, type='n')
XX<-seq(min(Lugworms_vec), max(Lugworms_vec), 0.1)
Y_fem<- t(sapply(XX, FUN=function(x)
                 quantile(x*13.2 /(x+fuelling_model$BUGSoutput$sims.list$K_sat_f),
		 probs=c(0.025, 0.5,0.975))))
lines(Y_fem[,1]~XX, lty=1)
lines(Y_fem[,2]~XX, lwd=2)
lines(Y_fem[,3]~XX, lty=1)
for (i in 1:length(Lugworms_vec)) {
   points(fuelling_model$BUGSoutput$mean$Alpha_t[i,2]~Lugworms_vec[i],
   pch=21, cex=4, bg=My_colors[round(time_scales*100)][i], lwd=2)
   text(fuelling_model$BUGSoutput$mean$Alpha_t[i,2]~Lugworms_vec[i],
   labels = substr(Years[i],3,4))
}
box()

# Now the same but into pdf
pdf('fueling rate Oct 2016.pdf', useDingbats=FALSE, width=10, height=10)
par(mfrow=c(1,2))
#-----------------------------
# males plot
plot(fuelling_model$BUGSoutput$mean$Alpha_t[,1]~Lugworms_vec,
     ylim=c(3.5,8.5),  ylab='fueling rate (g per day)',
     xlab='lugworm density, ind. per sq.m', main='Males',  las=1, type='n')
XX<-seq(min(Lugworms_vec), max(Lugworms_vec), 0.1)
Y_m<- t(sapply(XX, FUN=function(x) 
              quantile(x*11 /(x+fuelling_model$BUGSoutput$sims.list$K_sat_m),
	      probs=c(0.025, 0.5,0.975))))
lines(Y_m[,1]~XX, lty=2)
lines(Y_m[,2]~XX, lwd=2)
lines(Y_m[,3]~XX, lty=2)
for (i in 1:length(Lugworms_vec)) {
   points(fuelling_model$BUGSoutput$mean$Alpha_t[i,1]~Lugworms_vec[i],
   pch=21, cex=4, bg=My_colors[round(time_scales*100)][i], lwd=2)
   text(fuelling_model$BUGSoutput$mean$Alpha_t[i,1]~Lugworms_vec[i],
   labels = substr(Years[i],3,4))
}
box()

#-----------------
# females plot
plot(fuelling_model$BUGSoutput$mean$Alpha_t[,2]~Lugworms_vec,
     ylim=c(3.5,8.5),ylab='fueling rate (g per day)',
     xlab='lugworm density, ind. per sq.m', main='Females' ,las=1, type='n')
XX<-seq(min(Lugworms_vec), max(Lugworms_vec), 0.1)
Y_fem<- t(sapply(XX, FUN=function(x)
                 quantile(x*13.2 /(x+fuelling_model$BUGSoutput$sims.list$K_sat_f),
		 probs=c(0.025, 0.5,0.975))))
lines(Y_fem[,1]~XX, lty=1)
lines(Y_fem[,2]~XX, lwd=2)
lines(Y_fem[,3]~XX, lty=1)
for (i in 1:length(Lugworms_vec)) {
   points(fuelling_model$BUGSoutput$mean$Alpha_t[i,2]~Lugworms_vec[i],
   pch=21, cex=4, bg=My_colors[round(time_scales*100)][i], lwd=2)
   text(fuelling_model$BUGSoutput$mean$Alpha_t[i,2]~Lugworms_vec[i],
   labels = substr(Years[i],3,4))
}
box()
dev.off()
```
## 4. Departure fuel load effects on survival from capture-recapture data
We used Cormack–Jolly–Seber (CJS) model ([Lebreton et al., 1992](#lebreton)) to model apparent survival independently from resighting probability. Set of nested models was estimated in program MARK ([White & Burnham, 1999](#white)) through RMark ([Laake, 2013](#laake)) interface.  To run model estimation with MARK or RMark you should first install program MARK from [here](http://www.phidot.org/software/mark/downloads).
### 4.1 Load and combine data
```{r}
library('RMark')

# a. load main CR data
Full_CH<-read.csv('https://git.io/vXEFF', colClasses='character', row.names='code')
Full_CH$SEX<-as.factor(Full_CH$SEX)
Full_CH$Rin_Place<-as.factor(Full_CH$ Rin_Place)

# b. get arrivals to the Wadden Sea
Arrivals_WS<-read.csv('https://git.io/vXESW')

# c. get arrival weights
Arrival_weights<-read.csv('https://git.io/vXEbX')

# d. get annual slopes
Fuelling_slopes<-read.csv('https://git.io/vXEb5')

# e. get departures from Wadden Sea through arrival to Taimyr
Arrival_Taimyr<-read.csv('https://git.io/vXEbj')
Departures_Wadden<-Arrival_Taimyr[,c(1,3)]
Departures_Wadden$yday<-Departures_Wadden$yday-4
names(Departures_Wadden)[2]<-'departure'

# f. now we combine all these measurements.
All_staging_data<-merge(merge(merge(Arrivals_WS[,1:2], 
                        Arrival_weights), Fuelling_slopes),Departures_Wadden)
All_staging_data$Departure_fuel_load_females<-All_staging_data$Fuelling_slope_females*
                                  (All_staging_data$departure-All_staging_data$arrival)
All_staging_data$Departure_fuel_load_females_predicted<-All_staging_data$Fuelling_slope_females_predicted*
                                  (All_staging_data$departure-All_staging_data$arrival)
All_staging_data$Departure_fuel_load_males<-All_staging_data$Fuelling_slope_males*
                                  (All_staging_data$departure-All_staging_data$arrival)
All_staging_data$Departure_fuel_load_males_predicted<-All_staging_data$Fuelling_slope_males_predicted*
                                  (All_staging_data$departure-All_staging_data$arrival)

Departure_Weight_gain_Females<-rbind(
    cbind(group='fCas', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_females, Departure_fuel_load_females_predicted))),
	cbind(group='fWad', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_females, Departure_fuel_load_females_predicted))))
names(Departure_Weight_gain_Females)[3]<-'Weight_gain'
names(Departure_Weight_gain_Females)[4]<-'Weight_gain_predicted'
Departure_Weight_gain_Males<- rbind(
	cbind(group='mCas', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_males, Departure_fuel_load_males_predicted))),
	cbind(group='mWad', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_males, Departure_fuel_load_males_predicted))))
names(Departure_Weight_gain_Males)[3]<-'Weight_gain'
names(Departure_Weight_gain_Males)[4]<-'Weight_gain_predicted'
Departure_Weight_gain<-rbind(Departure_Weight_gain_Females, Departure_Weight_gain_Males)
names(Departure_Weight_gain)[2]<-'time'
Departure_Weight_gain<-subset(Departure_Weight_gain, time>2000)
```
## 4.2 Prepare data in RMark
```{r}
Godwit.data<-process.data(Full_CH, model = "CJS", begin.time = 2001,
                          groups=c("SEX", "Rin_Place"))
Godwit.ddl<-make.design.data(Godwit.data, remove.unused = FALSE)
Godwit.ddl$Phi<-merge_design.covariates(Godwit.ddl$Phi, Departure_Weight_gain,
                                        bygroup=TRUE, bytime=TRUE)
# specify first year after marking birds
Godwit.ddl$Phi$two_plus=0
Godwit.ddl$Phi$two_plus[Godwit.ddl$Phi$Age>=1]=1
Godwit.ddl$p$two_plus=0
Godwit.ddl$p$two_plus[Godwit.ddl$p$Age>=1]=1

# we now scale and center weights by SEX
Godwit.ddl$Phi$Weight_gain_st<-NA
Godwit.ddl$Phi$Weight_gain_st[Godwit.ddl$Phi$SEX=='m']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain[Godwit.ddl$Phi$SEX=='m']))
Godwit.ddl$Phi$Weight_gain_st[Godwit.ddl$Phi$SEX=='f']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain[Godwit.ddl$Phi$SEX=='f']))

# we now scale and center predicted from stayover duration and lugworm abundance weights by SEX
Godwit.ddl$Phi$Weight_gain_pr_st<-NA
Godwit.ddl$Phi$Weight_gain_pr_st[Godwit.ddl$Phi$SEX=='m']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain_predicted[Godwit.ddl$Phi$SEX=='m']))
Godwit.ddl$Phi$Weight_gain_pr_st[Godwit.ddl$Phi$SEX=='f']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain_predicted[Godwit.ddl$Phi$SEX=='f']))

# clean from previous runs in case there have been any
if (exists('cml')) {
   suppressWarnings(rm(list=cml[,1]))
   suppressWarnings(rm(list=cml[,2]))
} 
# specify model
# Survival part
Phi.weight_gain_pr=list(formula=~ Weight_gain_pr_st)	
Phi.TSM=list(formula=~two_plus)
Phi.SEX=list(formula=~SEX)
Phi.weight_gain.plus.TSM.plus.SEX=list(formula=~two_plus + Weight_gain_pr_st+SEX)
Phi.weight_gain_pr.plus.TSM=list(formula=~two_plus + Weight_gain_pr_st)
Phi.dot=list(formula=~1)
# Resighting part	
p.time.plus.place.plus.sex=list(formula=~time + Rin_Place+SEX)

cml=create.model.list("CJS")
```
### 4.3 Run MARK model
```{r}
if (Run_everything) {
   Res<-  mark.wrapper(cml, data=Godwit.data, ddl=Godwit.ddl, delete=FALSE, profile.int=F)
   saveRDS(Res, file='survival_result.RDS')
} else {
   Res<-readRDS(gzcon(url('https://git.io/vXueC')))
}
```
### 4.4 median c-hat test in MARK
We now have to estimate potential overdispersion and correct for it. This possibility currently does not exist in RMark, so we export data to MARK and do test there. 
```{r}
export.MARK(Godwit.data, 'godwit_data', Res, replace=TRUE)
```
>Estimated c-hat = 1.1445372 with sampling SE = 0.0037387
>95% Conf. Interval c-hat = 1.0882953 to 1.2007791

So we can adjust our response 
```{r}
Res_adj<-adjust.chat(Res, chat=1.1445372)
```
### 4.5 Prediction from the best model
```{r}
Model<-Res_adj[[6]]
Male_weight_pr<-Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad']
Male_weight_pr_sc<-scale(Male_weight_pr)
Male_weight_cov_sc<-seq(min(Male_weight_pr), max(Male_weight_pr), by=0.1)
Male_weight_cov_sc<-seq(-10, 10, by=0.1)

Female_weight_pr<-Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad']
Female_weight_pr_cs<-scale(Female_weight_pr)
Female_weight_cov_sc<-seq(min(Female_weight_pr_cs), max(Female_weight_pr_cs), by=0.1)
Female_weight_cov_sc<-seq(-10,10, by=0.1)

Design<-matrix(nrow=1, ncol=19, data=0)
Design[,1]<-1
Design[,2]<-1

Estimates_males<-c()
for (i in 1:length(Male_weight_cov_sc)) {
   Design[,3]<-Male_weight_cov_sc[i]
   Estimates_males<-rbind(Estimates_males, cbind(Male_weight_cov_sc=Male_weight_cov_sc[i],
                            get.real(Model, 'Phi', pim=FALSE, design=Design, se=T)[1,3:6]))
}
Estimates_males$Male_weight_cov<-Estimates_males$Male_weight_cov_sc*
                            attr(Male_weight_pr_cs,'scaled:scale') +
			    attr(Male_weight_pr_cs,'scaled:center') 

Design<-matrix(nrow=1, ncol=19, data=0)
Design[,1]<-1
Design[,2]<-1

Estimates_females<-c()
for (i in 1:length(Female_weight_cov_sc)) {
    Design[,3]<-Female_weight_cov_sc[i]
    Estimates_females<-rbind(Estimates_females, cbind(Female_weight_cov_sc=Female_weight_cov_sc[i],
                            get.real(Model, 'Phi', pim=FALSE, design=Design, se=T)[1,3:6]))
}
Estimates_females$Female_weight_cov<-Estimates_females$Female_weight_cov_sc*
                            attr(Female_weight_pr_cs,'scaled:scale') +
			    attr(Female_weight_pr_cs,'scaled:center') 
write.csv(Estimates_females, file='female_survival_prediction.csv', row.names=TRUE)
```

## References

1. Brown, R. D. & Robinson, D. A. Northern Hemisphere spring snow cover variability and change over 1922–2010 including an assessment of uncertainty. The Cryosphere 5, 219–229 (2011).<a id="brown-robinson"></a>
1. Lappo, E., Tomkovich, P. & Syroechkovskiy, E. Atlas of breeding waders in the Russian Arctic. (2012).<a id="lappo"></a>
1. van Gils, J. A. et al. Body shrinkage due to Arctic warming reduces red knot fitness in tropical wintering range. Science 352, 819–821 (2016).<a id="van-gils"></a>
1. Lindén, A. & Mäntyniemi, S. Using the negative binomial distribution to model overdispersion in ecological count data. Ecology 92, 1414–1421 (2011).<a id="lindén-mäntyniemi"></a>
1. Plummer, M. JAGS: A program for analysis of Bayesian graphical models using Gibbs sampling. (2003).<a id="plummer"></a>
1. Su, Y.-S. & Masanao Yajima. R2jags: Using R to Run ‘JAGS’. (2015).<a id="su-yahima"></a>
1. Lebreton, J.-D., Burnham, K. P., Clobert, J. & Anderson, D. R. Modeling survival and testing biological hypotheses using marked animals: a unified approach with case studies. Ecol. Monogr. 62, 67–118 (1992).<a id="lebreton"></a>
1. White, G. C. & Burnham, K. P. Program MARK: survival estimation from populations of marked animals. Bird Study 46, S120–S139 (1999).<a id="white"></a>
1. Laake, J. L. RMark: An R interface for analysis of capture-recapture data with MARK. 25 (Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv., 2013).<a id="laake"></a>
