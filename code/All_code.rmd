# Supplementary code to 'Fuelling conditions at staging sites can mitigate Arctic warming effects in a migratory bird' by Rakhimberidev et al., submitted

_code by Eldar Rakhimberdiev_

You might enjoy [html version of this supplementary](http://htmlpreview.github.io/?https://github.com/eldarrak/Godwits_worms_and_climate_change/blob/master/code/All_code.html?raw=true).

## 0. Set up output and run options
```{r}
set.seed(123)
```
### 0.1 To run or to load?
Parts of this code take time to run, so if you want to go through examples fast and do not want to install all the software
```{r}
Run_everything=FALSE # Change to TRUE if you want run everything by your computer
```

### 0.2 Online or local data?
This script can operate with online or local data. If `Use_local_data` set to TRUE working directory expected to have folders `data`. If `Run_everything` set to TRUE `results` directory will be created and all results will be saved there.
```{r}
Use_local_data=FALSE # Change to TRUE if you want to use local data
```

### 0.3 Checks and downloads 
```{r}
if (Use_local_data) {
   if (!'results' %in% list.dirs(full.names=FALSE, recursive=FALSE)) {
       if (Run_everything) {
          dir.create('results')
	   } else {
	      stop('results directory not found!')
	   }
   } 
   if (!'data' %in% list.dirs(full.names=FALSE, recursive=FALSE)) stop('data directory not found!')
} else {
   if (!'results' %in% list.dirs(full.names=FALSE, recursive=FALSE)) dir.create('results')
   download.file('https://git.io/vXAZ1', destfile='./results/Snow_remote.csv')
   download.file('https://git.io/vXgZG', destfile='./results/migration_model.RDS', mode='wb')
   download.file('https://git.io/vXED0', destfile='./results/Arrivals_migration_model.csv')
   download.file('https://git.io/vFM79', destfile='./results/fuelling_model.RDS',mode='wb')
   download.file('https://git.io/v7D8z', destfile='./results/phenology_SEM.RDS',mode='wb')
   download.file('https://git.io/vXEbX', destfile='./results/Arrival_weights.csv')
   download.file('https://git.io/vFM72', destfile='./results/Fuelling_slopes.csv')
   download.file('https://git.io/vXueC', destfile='./results/survival_result.RDS',mode='wb')
   download.file('https://git.io/vXuqH', destfile='./results/Mauritania_counts_model.RDS',mode='wb')
}
if (Use_local_data & !'data' %in% list.dirs(full.names=FALSE, recursive=FALSE)) stop('data directory not found') 

```
### 0.4 Plot on screen or save plots as pdfs?
Parts of this code take time to run, so if you want to go through examples fast you can specify
```{r}
Save_pdf=FALSE # Change to TRUE if you want to save pdf of figures.
```

## 1. Determining the date of snowmelt on the breeding grounds at the Taimyr Peninsula from remote sensing data. 
We used NOAA CDR snow cover extent based on remote sensed data [Brown & Robinson 2011](#brown-robinson). Weekly snow cover data were downloaded on 24×24 km grid and subset by the _Limosa lapponica taymyrensis_ breeding range [Lappo et al. 2012](#lappo). Following code provided in [van Gils et al 2016](#van-gils), we extracted date 50% spring snow coverage as linearly interpolated time point at which mean snow cover first time in a year crossed 50%, results are presented in Supplementary Materials Table S1.

### 1.1 Download publically available data
Load required packages
```{r}
library(ncdf4)
library(raster)
library(rgdal)
library(maptools)
library(maps)
library(RCurl)
library(fields)
```
Download taimyrensis bar-trailed godwit [(_Limosa lapponica taymyrensis_) range](#lappo) from this GitHub repo
```{r}
if (Use_local_data) {
   area.longlat<-readRDS('data/taimyrensis_godwit_area.RDS')
} else {
   area.longlat<-readRDS(gzcon(url('https://git.io/vXRBz')))
}
```
Download and read in R all [snow data from NOAA](#brown-robinson)
```{r cache=TRUE} 
# first we get filename of the latest file
Page<-getURL('https://www.ncei.noaa.gov/data/snow-cover-extent/access/',
             ssl.verifypeer = FALSE, dirlistonly = TRUE, ftp.use.epsv = FALSE)
filename<-paste0('https://www.ncei.noaa.gov/data/snow-cover-extent/access/nhsce_v01r01_19661004_',
             substr(strsplit(Page, 'nhsce_v01r01_19661004_')[[1]][2], start=1, stop=11))
download.file(filename, destfile='snow.nc', mode="wb")
dat <- nc_open('snow.nc')
t <- ncvar_get(dat,'time') ## "days since 1966-10-03"
z <- ncvar_get(dat,'snow_cover_extent')
ylat <- ncvar_get(dat,'latitude')
xlon <- ncvar_get(dat,'longitude')

nc_close(dat)
```

### 1.2 Projection and raster extent
```{r}
lon <- raster(xlon)
lat <- raster(ylat)
snow <- brick(z)

start <- as.POSIXct("1966-10-03", "GMT")
date <- start + ((t-6)*24*60*60)

projSnow <- "+proj=stere +lat_0=90 +lon_0=10"
xy <- project(cbind(values(lon), values(lat)), projSnow)
area <- spTransform(area.longlat, CRS(projSnow))
Grid_centers<-SpatialPoints(xy, proj4string=CRS(projSnow))
Grid_centers_lon_lat<-spTransform(Grid_centers, CRS=CRS(proj4string(area.longlat)))
```

### 1.3 Select and plot snow points
```{r}
# select snow points within godwtis's area
Selected_Points<-which(!is.na(over(Grid_centers, area)))
# Ok now we want to take two points closest to the field site
Field_site<-cbind(106.0,72.8)
Selected_Points_near_field_station<-Selected_Points[
     sort(order(spDists(coordinates(Grid_centers_lon_lat[Selected_Points,]),
	 Field_site, longlat=TRUE))[1:2])]

# Plot
Colors<-c('#1b9e77', '#d95f02', '#7570b3')
plot(area.longlat)
map('world', add=T, col=grey(0.9), fill=TRUE )
map('world', add=T, col=grey(0.5), lwd=2)
plot(area.longlat, border=grey(0.3),  lwd=2, add=T, col='#bae4bc')
# plot all snow grid points around
plot(Grid_centers_lon_lat, col=Colors[1], add=TRUE, pch=19, cex=2) 
# plot snow grid points withing godwits range
plot(Grid_centers_lon_lat[Selected_Points,], col=Colors[2], pch=19, cex=2, add=TRUE)
# field site
points(Field_site[1],Field_site[2], pch=17, cex=2, col=2)
# two closes points to the field site
plot(Grid_centers_lon_lat[Selected_Points_near_field_station,], col=Colors[3], pch=19, cex=2, add=TRUE)
```

### 1.4 Extract first date of snowmelt
```{r}
Res<-c()
   for(i in 1982:2017) {
        ind <- which(as.numeric(format(date, "%Y"))==i &
	               as.numeric(format(as.POSIXct(date), format='%m'))<8) 
        M<-snow@data@values[Selected_Points,ind]
        M_Southern<-snow@data@values[Selected_Points_near_field_station,ind]
	    # we now want to get last point with non zero snow coverage
		Mean_all<-mean(as.numeric(format(c(date[ind][
		               apply(M, 1, FUN=function(x) which(x==0)[1])-1]), '%j')))
		Mean_Southern<-mean(as.numeric(format(date[ind][
		               apply(M_Southern, 1, FUN=function(x) which(x==0)[1])-1], '%j')))
		Res<-rbind(Res, cbind(i, Mean_all, Mean_Southern))
   }

Snow_remote<-as.data.frame(Res)
names(Snow_remote)<-c('Yr', 'jdate50', 'jdate50_south')   
write.csv(Snow_remote, file='./results/Snow_remote.csv', row.names=FALSE)

plot(jdate50~Yr, data=Snow_remote, pch=19, col=Colors[2], 
     ylim=range(c(Snow_remote[,2], Snow_remote[,3])), las=1, xlab='Year', cex=2)
summary(lm(jdate50~Yr, data=subset(Snow_remote, Yr>1995 & Yr<2017)))

## checking for correlation between local and global snow
summary(lm(jdate50-jdate50_south~1, data=subset(Snow_remote)))
```

### 1.5 Comparison of remote sensing data with ground observations
```{r}
   Snow_remote<-read.csv('./results/Snow_remote.csv')
if (Use_local_data) {
   Snow_ground<-read.csv('./data/Snow_ground.csv')
} else {
   Snow_ground<-read.csv('https://git.io/vXAnO')
}
# now we merge them
Snow_all<-merge(Snow_remote, Snow_ground)
plot(jdate50_south~ jdate50_ground, data=Snow_all, pch=19, cex=2, col=Colors[3], las=1,
     xlab='Snow 50% date from ground observations (yday)',
	 ylab='Snow 50% date from remote data (yday)')
# draw regression line
abline(a=0, b=1, col=1, lwd=2)
abline(lm(jdate50_south~ jdate50_ground, data=Snow_all), lwd=2, col=Colors[3])
# now formally check the regression
print(summary(lm(jdate50_south~ jdate50_ground, data=Snow_all)))
# slope does not differ from 1:
print(summary(lm(I(jdate50_south- jdate50_ground)~jdate50_ground, data=Snow_all)))
# and Intercept from 0
print(summary(lm(I(jdate50_south- jdate50_ground)~1, data=Snow_all)))
```

## 2. Determining godwit arrival dates to the Wadden Sea using citizen science data
We used data from citizen science project www.trektellen.nl and modelled them with approach similar to one used in Lindén & Mäntyniemi ([2011](#lindén-mäntyniemi)). Model was estimated with JAGS sampler ([Plummer 2003](#plummer)) via R2jags ([Su & Yahima 2015](#su-yahima)) interface from R.
_To run code from this chapter you need to install JAGS software._

### 2.1 Load packages and data
```{r}
library(R2jags)

if (Use_local_data) {
   sites_years_dates<-read.csv('./data/godwit_trektellen_seven_major_sites.csv', as.is=TRUE)
} else {
   sites_years_dates<-read.csv('https://git.io/vXEBH', as.is=TRUE)
}
```

### 2.2 Formulate model in JAGS language
```{r results='hide'}
{
sink("migration_model.jags") 
cat("
model {
    # Model
    for (Obs in 1:nObs) {    
      log(N[Obs])<-a0 + total_k[Year[Obs]] +
	  site_i[Site[Obs]]+Offset[Obs]-((Date[Obs]-
	  T_0k[Year[Obs]])^2)/(2*sigma[Year[Obs]]^2)-
	  0.9189385-log(sigma[Year[Obs]])
	  
	# Bayesian p-value
    eval[Obs]<-p[Obs]*r/(1-p[Obs])
	
	E[Obs]<-pow(( Y[Obs]-eval[Obs]), 2)/(eval[Obs]) # +0.5 following Kery & Schaub 2012

	Y.new[Obs]~dnegbin( p[Obs] , r)
	E.new[Obs]<-pow(( Y.new[Obs]-eval[Obs]), 2)/(eval[Obs])
	
   }	
    #Priors
    for (k in 1:nYears) {
       total_k_src[k] ~ dnorm(0, 0.10)
       T_0k[k]~dnorm(125, 0.1)
       sigma[k]~dnorm(2, 0.1)T(0,)
    }
    for (i in 1:nSites) {
      site_i_src[i] ~ dnorm(0, 0.10) 
    }
    site_i  <- site_i_src[] -mean(site_i_src[])
    total_k <- total_k_src[]-mean(total_k_src[])

    a0 ~ dnorm(6, 0.1)
    r ~ dgamma(0.01,0.01)
    for (Obs in 1:nObs) { 
      p[Obs]<- r/(r+N[Obs])
    }
    #Likelihood
    for (Obs in 1:nObs) {
       Y[Obs]~dnegbin( p[Obs] , r )
    }
	
	fit<-sum(E[])
	fit.new<-sum(E.new[])
	
}",fill = TRUE)
sink()
}
```

### 2.3 Prepare data and initial values
```{r}
Data<-list('nObs'=nrow(sites_years_dates),
           'nYears'=length(unique(sites_years_dates$Year)),
           'nSites'=length(unique(sites_years_dates$Site)),
           'Year'=as.numeric(as.factor(sites_years_dates$Year)),
           'Site'=as.numeric(as.factor(sites_years_dates$Site)),
           'Date'=sites_years_dates$Date,
           'Offset'=sites_years_dates$Offset,
           'Y'=sites_years_dates$Y)
nSites=length(unique(sites_years_dates$Site))
nYears=length(unique(sites_years_dates$Year))
inits=function() {list(
           'a0' =runif(1,3,10),
           'total_k_src'=rnorm(nYears, 0, 1), 
           'T_0k'=rnorm(nYears, 125, 2),
           'site_i_src'=log(plogis(rnorm(nSites, 0, 0.5))),
           'sigma'=rnorm(nYears, 8, 2))
}
jags.params=c("a0","total_k", "T_0k", "site_i", "sigma", "r", "fit", "fit.new")
```

### 2.4 Run the model
```{r}
if (Run_everything) {
   # following run takes ~ 5 minutes brt
   nchains=4
   migration_model<-jags.parallel(data=Data, 
                  inits, 
                  parameters=jags.params, 
                  "migration_model.jags", 
                  n.chains = nchains, 
                  n.thin   = 3, 
                  n.iter   = 500, 
                  n.burnin = 200, 
                  working.directory = getwd())
   saveRDS(migration_model, file='./results/migration_model.RDS')
} else {
   if (Use_local_data) {   
       migration_model<-readRDS('./results/migration_model.RDS')
   } else {
       migration_model<-readRDS(gzcon(url('https://git.io/vXgZG')))
   }
}
```

### 2.5 Look at the output
```{r}
print(migration_model)

cat('Bayesian p-value = ', 
    mean(migration_model$BUGSoutput$sims.list$fit.new<migration_model$BUGSoutput$sims.list$fit), '\n')
cat('lack of fit ratio = ',
    mean(migration_model$BUGSoutput$sims.list$fit)/mean(migration_model$BUGSoutput$sims.list$fit.new), '\n')

Arrivals<-data.frame(Yr=unique(sites_years_dates$Year_real), 
                     arrival=migration_model$BUGSoutput$mean$T_0k,
                     sigma=migration_model$BUGSoutput$mean$sigma)
write.csv(Arrivals, file="./results/Arrivals_migration_model.csv", row.names=F)
```


## 3. Structural equations modelling of the phenology data

### 3.1 Load packages and data

Here we load **arrival time** estimated in 2.5 data on lugworm densities in the Dutch Wadden Sea.
```{r}
library(R2jags)
   Arrivals_WZ<-read.csv('./results/Arrivals_migration_model.csv')
   Snowmelt<-read.csv('./results/Snow_remote.csv', as.is=TRUE)
      
if (Use_local_data) {
   # read clutch initiation data
   Nests<-read.csv('./data/Nests.csv', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('./data/Tipula.csv', as.is=TRUE)
   # read arrivals to Khatanga
   Arr_Taimyr<-read.csv('./data/Arrivals_Khat.csv', as.is=TRUE)
} else {
   # read clutch initiation data
   Nests<-read.csv('https://git.io/vXu3y', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('https://git.io/vXu3x', as.is=TRUE)
   # read arrivals to Khatanga
   Arr_Taimyr<-read.csv('https://git.io/vXusf', as.is=TRUE)
}
```
Merge data

```{r}
tmp<-merge(Arrivals_WZ[,1:2], Snowmelt[,1:2], all=TRUE)
names(tmp)[2:3]<-c('Arrivals_WZ', 'Snowmelt')
tmp<-merge(tmp, Arr_Taimyr[,c(1,3)], all=TRUE)
names(tmp)[4]<-'Arr_T'

tmp<-merge(tmp, subset(Tipula, Region=='South', select=c('Yr', 'yday')), all=TRUE)
names(tmp)[5]<-'Tipula'

Data_all<-subset(tmp, Yr>=1992)

Nests<-subset(Nests, Region=='South', select=c('Yr', 'yday'))
Nests<-Nests[order(Nests$Yr),]

Years2nests<-sapply(Nests$Yr, FUN=function(x) which(Data_all$Yr==x))

```
### 3.2 Formulate model
```{r results='hide'}
{
sink("pathsimple.scaled.jags")		
cat("
model {
# The model

for (i in 1:length(time)) {
Arr_WZ_exp[i] =  b1.1*time[i]
Arr_WZ[i] ~ dnorm(Arr_WZ_exp[i], Arr_WZ_tau)

Snowmelt_exp[i] =  b2.1*time[i]
Snowmelt[i] ~ dnorm(Snowmelt_exp[i], Snowmelt_tau)

Arr_T_exp[i] = b3.1*time[i] + b3.2*Snowmelt[i] + b3.3*Arr_WZ[i]
Arr_T[i] ~ dnorm(Arr_T_exp[i], Arr_T_tau)

Tipula_exp[i] = b4.1*time[i] + b4.2*Snowmelt[i] 
Tipula[i] ~ dnorm(Tipula_exp[i], Tipula_tau)

Breeding_exp[i] =  b5.1*time[i] + b5.2*Snowmelt[i] + b5.3 * Arr_T[i] + b5.4*Tipula[i]

# Note that clutch initiation dates are called breeding in the model
Breeding[i] ~ dnorm(Breeding_exp[i], Breeding_tau)

# so I will just add another loop
}

for (nest in 1:length(Nests)) {
Nests[nest]~dnorm(Breeding[Years2nests[nest]], Nests_tau)
}

## Priors
b1.1 ~ dnorm(0,0.00001);

Arr_WZ_tau = pow(Arr_WZ_sigma, -2)
Arr_WZ_sigma ~ dnorm(0,1)T(0,)

b2.1 ~ dnorm(0,0.00001)
Snowmelt_tau = pow(Snowmelt_sigma, -2)
Snowmelt_sigma  ~ dnorm(0,1)T(0,)

b3.1 ~ dnorm(0,0.00001); b3.2 ~ dnorm(0,0.00001);b3.3 ~ dnorm(0,0.00001)
Arr_T_tau = pow(Arr_T_sigma, -2)
Arr_T_sigma ~ dnorm(0,1)T(0,)

b4.1 ~ dnorm(0,0.00001); b4.2 ~ dnorm(0,0.00001)
Tipula_tau = pow(Tipula_sigma, -2)
Tipula_sigma ~ dnorm(0,1)T(0,)

b5.1 ~ dnorm(0,0.00001); b5.2 ~ dnorm(0,0.00001); 
b5.3 ~ dnorm(0,0.00001); b5.4 ~ dnorm(0,0.00001);
Breeding_tau = pow(Breeding_sigma, -2)
Breeding_sigma ~ dnorm(0,1)T(0,)

Nests_tau = pow(Nests_sigma, -2)
Nests_sigma ~ dnorm(0,1)T(0,)
}
",fill=TRUE)
sink()
}
```
### 3.3 Prepare data and initial values
Model does not have intercepts, so it is important to center data

```{r}
Data_cent<-list(Arr_WZ=scale(subset(Data_all, select=Arrivals_WZ, drop=TRUE), scale=FALSE)[,1],
           Snowmelt=scale(subset(Data_all, select=Snowmelt, drop=TRUE), scale=FALSE)[,1],
           Arr_T=scale(subset(Data_all, select=Arr_T, drop=TRUE), scale=FALSE)[,1],
           Tipula=scale(subset(Data_all, select=Tipula, drop=TRUE), scale=FALSE)[,1],
           Nests=scale(Nests[,2], scale=FALSE)[,1],
		   Years2nests=Years2nests, 
		   time=seq(-12, 12))

Inits<-function() { 
          list(
               b1.1=runif(1,-1, 1),
               b2.1=runif(1,-1, 1),
               b3.1=runif(1,-1, 1),
               b3.2=runif(1,-1, 1),
               b3.3=runif(1,-1, 1),
               b4.1=runif(1,-1, 1),
               b4.2=runif(1,-1, 1),
               b5.1=runif(1,-1, 1),
               b5.2=runif(1,-1, 1),
               b5.3=runif(1,-1, 1),
               b5.4=runif(1,-1, 1),
			   Arr_WZ_sigma=1,
			   Snowmelt_sigma=1,
			   Arr_T_sigma=1,
			   Tipula_sigma=1,
			   Breeding_sigma=1,
			   Nests_sigma=1)
}


Parameters<-c('b1.1', 
               'b2.1',
			  'b3.1', 'b3.2', 'b3.3',
			   'b4.1', 'b4.2',
			  'b5.1', 'b5.2', 'b5.3', 'b5.4',
			  'Arr_WZ_sigma', 'Snowmelt_sigma', 'Arr_T_sigma', 'Breeding_sigma', 'Nests_sigma')
```
### 3.4 Run the model
```{r results='hide'}
if (Run_everything) {
   # following run takes ~ 4 minutes brt			  
   phenology_SEM<-jags.parallel(data=Data_cent ,
                  Inits, 
                  parameters=Parameters, 
                  "pathsimple.scaled.jags", 
                  n.chains = 5, 
                  n.thin   = 500, 
                  n.iter   = 1000000,
                  n.burnin = 100000)
   saveRDS(phenology_SEM, file='./results/phenology_SEM.RDS')
}
phenology_SEM<-readRDS('./results/phenology_SEM.RDS')
```

### 3.5 Explore and save model results
```{r}
print(phenology_SEM)

Parameter.Index<-which(substr(names(phenology_SEM$BUGSoutput$sims.list),1,1)=='b')
SEM_coefs<-data.frame(
   'mean'=sapply(phenology_SEM$BUGSoutput$sims.list[Parameter.Index],
       FUN=function(x) mean(x)), 
   'sd'=sapply(phenology_SEM$BUGSoutput$sims.list[Parameter.Index],
       FUN=function(x) sd(x)), 
	'median'=sapply(phenology_SEM$BUGSoutput$sims.list[Parameter.Index],
	   FUN=function(x) median(x)),
	'2.5%'=sapply(phenology_SEM$BUGSoutput$sims.list[Parameter.Index],
	   FUN=function(x) quantile(x, 0.025)), 
	'97.5%'=sapply(phenology_SEM$BUGSoutput$sims.list[Parameter.Index],
	   FUN=function(x) quantile(x, 0.975)), 
 'P(|b|>0)'=sapply(phenology_SEM$BUGSoutput$sims.list[Parameter.Index],
        FUN=function(x) max(mean(x>0), mean(x<0))), check.names=FALSE)

 Vars<-data.frame(rbind(c('Time', 'Arrival Wadden Sea'),
     c('Time','Snowmelt'),
     c('Time', 'Arrival to Taimyr'),
     c('Snowmelt', 'Arrival to Taimyr'),
     c('Arrival Wadden Sea', 'Arrival to Taimyr'),
     c('Time', 'Crane fly emergence'),
     c('Snowmelt', 'Crane fly emergence'),
     c('Time', 'Clutch Initiation'),
     c('Snowmelt', 'Clutch Initiation'),
     c('Arrival to Taimyr', 'Clutch Initiation'),
     c('Crane fly emergence', 'Clutch Initiation')))
	 names(Vars)<-c('Effect of', 'on')
SEM_coefs<-cbind(Vars, SEM_coefs)
print(SEM_coefs, digits=2)
write.csv(SEM_coefs, file='./results/SEM_coefs.csv')
```

## 4. Spring migration speed and stopover duration of godwits from satellite tracking data
### 4.1 Download data
```{r results='hide'}
if (Use_local_data) {
   # read breeding data
   All_tracks<-read.csv('./data/barg_2016_tracks.csv', as.is=TRUE)
} else {
   All_tracks<-read.csv('https://git.io/v7gXj', as.is=TRUE)
}
All_tracks$Time<-as.POSIXct(All_tracks$Time, tz='GMT')
```

### 4.2 Estimate schedules
```{r}
Individuals<-unique(All_tracks$ID)
Schedules<-data.frame()

for (i in 1:length(Individuals)) {
   Track<-subset(All_tracks, ID==(Individuals[i]))
   Year<-unique(as.numeric(format(Track$Time, format='%Y')))
   New_time<-seq(min(Track$Time), max(Track$Time), by=60)
   New_lon<-approx(x=Track$Time, y=Track$lon, xout=New_time)$y
   New_lat<-approx(x=Track$Time, y=Track$lat, xout=New_time)$y
   Schedules<-rbind(Schedules, data.frame(Bird_id= (Individuals[i]),
                Dep_Mau=ifelse(New_lat[1]> 21.5, NA, New_time[which(New_lat>21.5)[1]]),
				Arr_WZ=ifelse(New_lat[1]> 21.5, NA, New_time[which(New_lat>52.5)[1]]),
				Dep_WZ=New_time[which(New_lon>10)[1]],
				Arr_Tai= New_time[which(New_lon>80)[1]],
    			year=Year))
}

Schedules[,2]<-as.POSIXct(Schedules[,2], tz="GMT", origin='1970-01-01')
Schedules[,3]<-as.POSIXct(Schedules[,3], tz="GMT", origin='1970-01-01')
Schedules$Migration_to_WZ<-as.numeric((difftime(Schedules[,3],Schedules[,2], units='days')))
Schedules$Refuelling<-as.numeric((difftime(Schedules[,4],Schedules[,3], units='days')))
Schedules$Migration_to_Tai<-as.numeric((difftime(Schedules[,5],Schedules[,4], units='days')))

print(mean(Schedules$Migration_to_Tai)) # 5.16
print(sd(Schedules$Migration_to_Tai)) # 2.09
length(Schedules$Migration_to_Tai) #8
print(median(Schedules$Migration_to_Tai)) #5.72
print(mean(Schedules$Migration_to_WZ, na.rm=TRUE)) # 3.78
```

### 4.3 Estimate stopovers
```{r}
Periods_all<-c()
for (i in 1:length(Individuals)) {
   Track<-subset(All_tracks, ID==(Individuals[i]) & Time<as.POSIXct('2016/06/24'))
   Year<-unique(as.numeric(format(Track$Time, format='%Y')))
   Index_stationary<-rep(1, length=length(spDists(cbind(Track$lon, Track$lat), longlat=TRUE, segments=TRUE)))
   Index_stationary[
             which(spDists(cbind(Track$lon, Track$lat), longlat=TRUE, segments=TRUE)>25)]<-0#>25km=>movement
   Starts<-unique(c(1, which(diff(Index_stationary)==1)+1))
   Ends<-unique(c(which(diff(Index_stationary)==-1)+1, length(Index_stationary)))
   Periods<-data.frame(Start_Index=Starts, End_Index=Ends,
                      Start_time=Track$Time[Starts], End_time=Track$Time[Ends])
   Periods$Duration<- (as.numeric(Periods$End_time)- as.numeric(Periods$Start_time))/3600/24 # in days
   Periods<-Periods[Periods$Duration>1,]

   Periods$Mean_lon<-sapply(1:nrow(Periods), 
               FUN=function(x) mean(Track$lon[Periods$Start_Index[x]: Periods$End_Index[x]]))
   Periods$Mean_lat<-sapply(1:nrow(Periods), 
               FUN=function(x) mean(Track$lat[Periods$Start_Index[x]: Periods$End_Index[x]]))
   Periods$Year= Year

   # and now I want to exclude ones in the wintering, Wadden Sea or breeding grounds
   Periods<-Periods[!(Periods$Mean_lat<21.5 | 
                  (Periods$Mean_lat>52.4 & Periods$Mean_lat<56 & Periods$Mean_lon > 4 & Periods$Mean_lon < 10) |
				  Periods$Mean_lon > 80),]
   if (nrow(Periods)>=1) {
       Periods_all<-rbind(Periods_all, Periods)
   }
}
 
print(mean(Periods_all$Duration)) # 1.8 days on average
print(nrow(Periods_all)) # 6 stopovers for longer than 24 hours.
print(length(which(Periods_all$Duration>2))) #only two stopover longer than 2 days.
```

## 5. Refuelling rates and their relationship with lugworm abundance

### 5.1 Estimate yearly arrival mass from Castricum data
```{r}
library(lme4)
if (Use_local_data) {
   Capture_data<-read.csv('./data/Capture_data.csv', as.is=TRUE)
} else {
   Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
}
Capture_data$date<-as.Date(Capture_data$date)

# arrival mass females
aggr_data_females<-subset(Capture_data, Sex==2 & Site == "Castricum")
aggr_data_females$fYr<-as.factor(aggr_data_females$Yr)
weight_model_females<-lmer(Mass~-1+(1|fYr), data=aggr_data_females)
mu_W0_females<-coef(weight_model_females)$fYr[,1]
sigma2_W0_females<-var(residuals(weight_model_females))

# arrival mass males
aggr_data_males<-subset(Capture_data,  Sex==1 & Site == "Castricum")
aggr_data_males$fYr<-as.factor(aggr_data_males$Yr)
weight_model_males<-lmer(Mass~-1+(1|fYr), data=aggr_data_males)
mu_W0_males<-coef(weight_model_males)$fYr[,1]
sigma2_W0_males<-var(residuals(weight_model_males)) 

Arrival_weights<-data.frame(Yr=as.numeric(levels(aggr_data_females$fYr)),
                            Male_arrival_weight=mu_W0_males,
			    Female_arrival_weight=mu_W0_females, Male_arrival_weight_sigma=sqrt(sigma2_W0_males),
	            Female_arrival_weight_sigma=sqrt(sigma2_W0_females))
write.csv(Arrival_weights, file='./results/Arrival_weights.csv', row.names=FALSE)
```

### 5.2 Load packages and data
Here we load **arrival time** estimated in 2.5 data on lugworm densities in the Dutch Wadden Sea.
```{r}
library(R2jags)
   Arrivals<-read.csv('./results/Arrivals_migration_model.csv')
   Arrival_weights<-read.csv('./results/Arrival_weights.csv')
if (Use_local_data) {
   Capture_data<-read.csv('./data/Capture_data.csv', as.is=TRUE)
   Lugworms<-read.csv('./data/Lugworms.csv')
} else {
   Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
   Lugworms<-read.csv('https://git.io/vXESR')
}
Lugworms<-subset(Lugworms, Yr>1995)
Capture_data$date<-as.Date(Capture_data$date)
names(Arrivals)[2]<-"arrival_day"
Data_to_model<-merge(subset(Capture_data, Site!='Castricum'), Arrivals)
Data_to_model<-subset(Data_to_model, Yr %in% Lugworms$Yr)
mu_T0<-Arrivals$arrival[Arrivals$Yr %in% unique(Data_to_model$Yr)]
sigma2_T0<-(Arrivals$sigma^2)[Arrivals$Yr %in% unique(Data_to_model$Yr)]
Lugworms_vec<-Lugworms[Lugworms$Yr %in% unique(Data_to_model$Yr),2]

```

### 5.3 Lugworm data validation
While refuelling in the Wadden Sea taymyrensis godwits concentrate near Terschelling Island (53.4°N, 5.34°E),  that is 50 km away from long term lugworm sampling area at Balgazand (52.9°N, 4.87°E). In order to validate use of Balgzand data on lugworm abundance for godwits we used shorter, but covering both areas dataset - Synoptic Intertidal Benthic Survey ([SIBES](https://www.nioz.nl/en/education/internships/assessing-the-macrozoobenthos-of-the-dutch-wadden-sea)) - large scale grid sampling of benthic fauna in the Wadden Sea ([Bijleveld et al. 2012](#bijleveld), [Compton et al. 2013](#compton)).  We used SIBES data from sampling stations within 500 meters from Terschelling coast (refuelling area) and from Balgzand for all available years (2008 - 2014). 
```{r}
if (Use_local_data) {
  Lugworms_SIBES<-read.csv('./data/lugworm_densities_two_sites.csv')
} else {
  Lugworms_SIBES<-read.csv('https://git.io/vMei1')
}
print(cor.test(Lugworms_SIBES$Balgzand,Lugworms_SIBES$Terschelling))
```
Data on both sites show correlated changes over years (Pearson's _r_=0.86) allowing us to use Balgzand data as a proxy for refuelling conditions for godwits.

### 5.4 Formulate model
```{r results='hide'}
{
sink("fuelling_model.jags")

cat("
    model {
    # prior
    for (i in 1:N) {    
       T0[i] ~ dnorm(mu_T0[i2k[i]], tau_T0[i2k[i], i2s[i]])
    }
    
    for(k in 1:K) {
       Alpha_t[k,1] ~ dnorm(Int_lug + Slope_lug*Lugworms[k],
	                         1/sigma2_alpha)
       Alpha_t[k,2] ~ dnorm(Int_lug_fem + Slope_lug_fem*Lugworms[k],
                             1/sigma2_alpha_fem)
	}

    # Likelihood
    for (i in 1:N) {
       Wt_mu[i] <- mu_W0[i2k[i],i2s[i]]+(Time[i]-T0[i])*(Alpha_t[i2k[i], i2s[i]])
       Wt[i] ~ dnorm(Wt_mu[i],Wt_tau[i2k[i], i2s[i]])
    }
  
    # params an hyper-priors
    for (k in 1:K) {
       for (s in 1:2) {
          Wt_s2[k,s] <- sigma2_W0[s]
          Wt_tau[k,s]<-1/Wt_s2[k,s]
       }
    }
    Int_lug~dnorm(10, 0.1)
    Int_lug_fem~dnorm(10, 0.1)
    Slope_lug~dunif(0, 1)
    Slope_lug_fem~dunif(0, 1)
    mu_alpha_fem~dnorm(10, 0.1)
    sigma2_alpha~dunif(0, 5)  
    sigma2_alpha_fem~dunif(0, 5)  
      
    for(k in 1:K) {
       tau_T0[k,1]<-1/(sigma2_T0[k]+sigma2_W0[1]/Alpha_t[k,1]) 
       tau_T0[k,2]<-1/(sigma2_T0[k]+sigma2_W0[2]/Alpha_t[k,2])
    }
}",fill = TRUE)
sink()
}
```

### 5.5 Prepare data and initial values
```{r}
Data=list(Wt=Data_to_model$Mass, Time=Data_to_model$yday,
          i2k=as.numeric(as.factor(Data_to_model$Yr)),
          i2s=Data_to_model$Sex, N=length(Data_to_model$Mass), 
	  K=length(unique(Data_to_model$Yr)),
	  mu_W0=subset(Arrival_weights, Yr %in% Lugworms$Yr,
	               select=c(Male_arrival_weight, Female_arrival_weight)), 
	  sigma2_W0=unique(subset(Arrival_weights, Yr %in% Lugworms$Yr,
	               select=c(Male_arrival_weight_sigma, Female_arrival_weight_sigma))^2)[1,,drop=TRUE]
				   , 
	  mu_T0=mu_T0,
	  sigma2_T0=sigma2_T0, Lugworms=Lugworms_vec)

inits=function() {
   list(
   Int_lug=rnorm(1, 0, 5),
   Int_lug_fem=rnorm(1, 0, 5),
   Slope_lug=runif(1, 0, 1),
   Slope_lug_fem=runif(1, 0, 1),
   sigma2_alpha=runif(1, 0, 5),
   sigma2_alpha_fem=runif(1, 0, 5))
}
jags.params=c("Alpha_t", "sigma2_alpha", "sigma2_alpha_fem",
              "Int_lug", "Int_lug_fem", "Slope_lug", "Slope_lug_fem")
```

### 5.6 Run the model
```{r results='hide'}
if (Run_everything) {
   # following run takes ~ 2 minutes brt
   fuelling_model<- jags(data=Data, inits, parameters=jags.params,
                    "fuelling_model.jags", n.chains = 2, n.thin = 10,
		    n.iter = 10000, n.burnin = 1000, working.directory = getwd())
   saveRDS(fuelling_model, file='./results/fuelling_model.RDS')
}
fuelling_model<-readRDS('./results/fuelling_model.RDS')
```

### 5.7 Explore and save model results
```{r}
print(fuelling_model)
Years<-unique(as.numeric((Data_to_model$Yr)))
# save estimated slopes for survival model
Fuelling_slopes<-data.frame(Yr=Years,
         Fuelling_slope_males=fuelling_model$BUGSoutput$mean$Alpha_t[,1],
         Fuelling_slope_females=fuelling_model$BUGSoutput$mean$Alpha_t[,2]
)
write.csv(Fuelling_slopes, file='./results/Fuelling_slopes.csv', row.names=FALSE)
```

## 6. Modelling the eEffects of refuelling time and refuelling rate on annual apparent survival probability
We used Cormack–Jolly–Seber (CJS) model ([Lebreton et al., 1992](#lebreton)) to model apparent survival independently from resighting probability. Set of nested models was estimated in program MARK ([White & Burnham, 1999](#white)) through RMark ([Laake, 2013](#laake)) interface.  To run model estimation with MARK or RMark you should first install program MARK from [here](http://www.phidot.org/software/mark/downloads).

### 6.1 Load and combine data
```{r}
library('RMark')
   #get arrivals to the Wadden Sea
   Arrivals_WS<-read.csv('./results/Arrivals_migration_model.csv')
   #get arrival mass
   Arrival_weights<-read.csv('./results/Arrival_weights.csv')
   #get annual slopes
   Fuelling_slopes<-read.csv('./results/Fuelling_slopes.csv')
if (Use_local_data) {
   # load main CR data
   Full_CH<-read.csv('./data/Full_CH.csv', colClasses='character', row.names='code')
   #get departures from Wadden Sea through arrival to Taimyr
   Arrival_Taimyr<-read.csv('./data/Arrivals_Khat.csv')
} else {
   #load main CR data
   Full_CH<-read.csv('https://git.io/vXEFF', colClasses='character', row.names='code')
   #get departures from Wadden Sea through arrival to Taimyr
   Arrival_Taimyr<-read.csv('https://git.io/vXEbj')
}

 Full_CH$SEX<-factor(Full_CH$SEX)


  # a. get arrivals to the Wadden Sea
   Arrivals_WS<-read.csv('./results/Arrivals_migration_model.csv')
   # b. get arrival mass
   Arrival_weights<-read.csv('./results/Arrival_weights.csv')
   # c. get annual slopes
   Fuelling_slopes<-read.csv('./results/Fuelling_slopes.csv')

Departures_Wadden<-Arrival_Taimyr[,c(1,3)]
Departures_Wadden$yday<-Departures_Wadden$yday-5.5
names(Departures_Wadden)[2]<-'departure'

   
# now we combine all these measurements.
All_staging_data<-merge(merge(merge(Arrivals_WS[,1:2], 
                        Arrival_weights), Fuelling_slopes),Departures_Wadden)
All_staging_data$Stopover<-(All_staging_data$departure-All_staging_data$arrival)

All_staging_data$log_fuelling_slope_females_st<-
           scale(log(All_staging_data$Fuelling_slope_females), center=TRUE, scale=FALSE)
All_staging_data$log_fuelling_slope_males_st<-
           scale(log(All_staging_data$Fuelling_slope_males), center=TRUE, scale=FALSE)
All_staging_data$log_Stopover<-scale(log((All_staging_data$departure-
                                      All_staging_data$arrival)), center=TRUE, scale=FALSE)
 
Departure_Weight_gain_Females<- cbind( group='f', subset(All_staging_data,
    select=c(Yr, log_fuelling_slope_females_st, log_Stopover)))
names(Departure_Weight_gain_Females)[3]<-'log_fuelling_slope'
names(Departure_Weight_gain_Females)[4]<-'log_Stopover'

Departure_Weight_gain_Males<- cbind(group='m', subset(All_staging_data,
    select=c(Yr, log_fuelling_slope_males_st, log_Stopover)))
names(Departure_Weight_gain_Males)[3]<-'log_fuelling_slope'
names(Departure_Weight_gain_Males)[4]<-'log_Stopover'

Departure_Weight_gain<-rbind(Departure_Weight_gain_Females, Departure_Weight_gain_Males)
names(Departure_Weight_gain)[2]<-'time'
Departure_Weight_gain<-subset(Departure_Weight_gain, time>2001 & time<2016)
```

### 6.2 Prepare data in RMark
```{r}
library('RMark')

Godwit.data<-process.data(Full_CH, model = "CJS", begin.time = 2002,
                          groups=c("SEX"))
Godwit.ddl<-make.design.data(Godwit.data, remove.unused = FALSE)
Godwit.ddl$Phi<-merge_design.covariates(Godwit.ddl$Phi, Departure_Weight_gain,
                                        bygroup=TRUE, bytime=TRUE)
# specify first year after marking birds
Godwit.ddl$Phi$two_plus=0
Godwit.ddl$Phi$two_plus[Godwit.ddl$Phi$Age>=1]=1
Godwit.ddl$p$two_plus=0
Godwit.ddl$p$two_plus[Godwit.ddl$p$Age>=1]=1

# clean from previous runs in case there have been any
if (exists('cml')) {
   suppressWarnings(rm(list=cml[,1]))
   suppressWarnings(rm(list=cml[,2]))
} 
# specify model
# Survival part
Phi.dot=list(formula=~1)
Phi.1=list(formula=~two_plus + log_fuelling_slope*SEX + log_Stopover*SEX)
Phi.2=list(formula=~two_plus + log_fuelling_slope*SEX + log_Stopover+SEX)
Phi.3=list(formula=~two_plus + log_fuelling_slope + log_Stopover*SEX)
Phi.4=list(formula=~two_plus + log_fuelling_slope + SEX +log_Stopover)
Phi.5=list(formula=~two_plus + log_Stopover*SEX)
Phi.6=list(formula=~two_plus + log_fuelling_slope*SEX)
Phi.7=list(formula=~two_plus + Time*SEX)
Phi.8=list(formula=~two_plus + Time + SEX)
Phi.9=list(formula=~two_plus + SEX)
# Resighting part   
p.time=list(formula=~time)

cml=create.model.list("CJS")
```

### 6.3 Run MARK model
```{r results='hide'}
if (Run_everything) {
   Res<-mark.wrapper(cml, data=Godwit.data, ddl=Godwit.ddl, profile.int=F, delete=FALSE, brief=TRUE)
   saveRDS(Res, file='./results/survival_result.RDS')
} else {
   Res<-readRDS('./results/survival_result.RDS')
}
```

### 6.4 Median c-hat test in MARK
We now have to estimate potential overdispersion and correct for it. This possibility currently does not exist in RMark, so we export data to MARK and do test there. 
```{r results='hide', eval=FALSE}
export.MARK(Godwit.data, 'godwit_data', Res, replace=TRUE)
```
>Estimated c-hat = 1.1186307 with sampling SE = 0.0045798
>95% Conf. Interval c-hat = 1.0623081 to 1.1749534

So we can adjust our result 
```{r}
Res_adj<-adjust.chat(Res, chat=1.1186307)
print(Res_adj)
```

## 7. Estimation of Pthe godwit population trends from winter counts in West Africa
We modelled change in total population of godwits in state space modelled suggested by Kéry & Schaub ([2012](#kery-schaub)), but with negative binomial error distribution.

### 7.1 Load packages and data
```{r}
library(R2jags)
if (Use_local_data) {
   Counts<-read.csv('/data/Counts_Mauritania.csv')
} else {
   Counts<-read.csv('https://git.io/vXuL5')
}
Areas<-sort(unique(Counts$Area))
Years<-seq( min(unique(Counts$Yr)), max(unique(Counts$Yr)), 1)
y.matrix<-matrix(ncol=length(Areas), nrow= length(Years))
for (i in 1:nrow(Counts)) {
   y.matrix[which(Years==Counts$Yr[i]), which(Areas==Counts$Area[i])]<-Counts$Count[i]
}
```

### 7.2 Formulate model
```{r results='hide'}
{
sink("winter_counts_model.jags")
cat(" 
model {
   # priors
   for (s in 1:S) {N.est[1,s] ~ dexp(exp.lam)}
   mean.lambda ~ dunif(0.5,1.5)
   for (s in 1:S) {r[s] ~ dgamma(0.01, 0.01)}
   for (t in 1:T) {n_total[t]<-sum(N.est[t,])}

   #likelihood
   # state process 
   for (t in 1:(T-1)) {
      for (s in 1:S) {
         N.est[t+1,s] <- N.est[t,s]*mean.lambda
      }
   }
   # Observation process
   for (t in 1:T) {
      for (s in 1:S) {
         p[t,s]<-r[s]/(r[s]+N.est[t,s])
         y[t, s] ~ dnegbin(p[t,s], r[s])
      }
   }
}
", fill=TRUE)
sink()
}
```

### 7.3 Priors and initial values
```{r}
exp.mean<-mean(as.double(y.matrix),na.rm=T)
exp.lam <-1/exp.mean

jags.data<-list(y=y.matrix, T=length(Years), S=length(Areas), exp.lam=exp.lam)
   
# initials
inits<-function() {list(
        N.est=matrix(ncol=6, nrow=15, c(runif(6, 0, 15000), rep(NA, 6*15-6)), byrow=TRUE),
        mean.lambda=runif(1, 0.5,1.5),
        r=runif(6,0,10))}
jags.params=c("n_total", "mean.lambda", "r")
```

### 7.4 Run the model
```{r results='hide'}
if (Run_everything) {
   # this model runs for ~ 2 mins brt
   Counts_model<- jags(data=jags.data, inits, parameters=jags.params,
   "winter_counts_model.jags", n.chains = 2, n.thin = 10, n.iter = 20000,
   n.burnin = 5000, working.directory = getwd())
   saveRDS(Counts_model, file='./results/Mauritania_counts_model.RDS')
}
Counts_model<-readRDS('./results/Mauritania_counts_model.RDS')
print(Counts_model)
```

## 8. Phenology plot (Fig. 1)
### 8.1 Load data 
```{r}
   # read Snow
   Snow<-read.csv('./results/Snow_remote.csv', as.is=TRUE)
   # read arrivals to Wadden Sea (predicted by arrival model)
   Arr_Wadden<-read.csv('./results/Arrivals_migration_model.csv')
   # read Mauritania counts model resutls
   Counts_model<-readRDS('./results/Mauritania_counts_model.RDS')

if (Use_local_data) {
   # read breeding data
   Nests<-read.csv('./data/Nests.csv', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('./data/Tipula.csv', as.is=TRUE)
   # read arrivals to Khatanga
   Arr_Taimyr<-read.csv('./data/Arrivals_Khat.csv', as.is=TRUE)
   # read raw counts
   Counts<-read.csv('./data/Counts_Mauritania.csv', as.is=TRUE)

} else {
   # read breeding data
   Nests<-read.csv('https://git.io/vXu3y', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('https://git.io/vXu3x', as.is=TRUE)
   # read arrivals to Khatanga
   Arr_Taimyr<-read.csv('https://git.io/vXusf', as.is=TRUE)
   # read raw counts
   Counts<-read.csv('https://git.io/vXuL5')
}

names(Snow)<-c('Yr', 'yday', 'yday_South')
Nests$Date<-as.Date(Nests$Date, tz='GMT', format='%Y-%m-%d' )
Tipula$Date<-as.Date(Tipula$Date, tz='GMT', format='%Y-%m-%d' )
Arr_Taimyr$Date<-as.Date(Arr_Taimyr$Date, tz='GMT', format='%Y-%m-%d' )
names(Arr_Wadden)[2]<-'yday'

   Areas<-sort(unique(Counts$Area))
   Years<-seq( min(unique(Counts$Yr)), max(unique(Counts$Yr)), 1)
   y.matrix<-matrix(ncol=length(Areas), nrow= length(Years))
   for (i in 1:nrow(Counts)) {
      y.matrix[which(Years==Counts$Yr[i]), which(Areas==Counts$Area[i])]<-Counts$Count[i]
   }
   Predicted_densities<-as.data.frame(cbind(Years, 
      t(apply(Counts_model$BUGSoutput$sims.list$n_total, 2,
      FUN=function(x) quantile(x, probs =c(0.025, 0.5, 0.975))))))
   names(Predicted_densities)[2:4]<-c("lcl", "median","ucl")

```

### 8.2 Plot the figure
```{r fig.width=3, fig.height=9}
if (Save_pdf) pdf('Figure 1.pdf', width=3, height=9, useDingbats=FALSE)
 m <- matrix(c(1,1,2))
 m
 layout(m)

   Snow_global_color<-'#8BAB8D' 
   Tipula_color<-'#8783CE'
   Khat_arr_color<-'#7B3575'
   Nest_color<-'#CC79A7'
   Arr_WZ_col<-'#F48F3B'
   Color_BA<-'#7B3575' 
   Ref_col<-'#FB7508'
   point_lwd=0.5
   point_cex=2 
   font_cex=0.6
   axes.labels.cex=1
   x_marg=1
   
par(mar=c(4,4,2,2))

# snowmelt
plot(yday~Yr, data=Snow, type='n', ylim=c(115, 190), las=1, xlim=c(1993, 2017),axes=FALSE, ylab='', xlab='')
 box()

 abline(h=152+15, col=grey(0.5), lty=2)
 abline(h=121+15, col=grey(0.5), lty=2)
 
 abline(h=121-7.5, col=grey(0.5), lty=3)
 abline(h=121+7.5, col=grey(0.5), lty=3)

 abline(h=182+7.5, col=grey(0.5), lty=3)
 abline(h=152+15+7.5, col=grey(0.5), lty=3)
 abline(h=152+7.5, col=grey(0.5), lty=3)
 abline(h=121+15+7.5, col=grey(0.5), lty=3)

 abline(v=1995, col=grey(0.5))
 abline(v=2015, col=grey(0.5))
 abline(v=2005, col=grey(0.5), lty=2)

 abline(v=2000, col=grey(0.5), lty=3)
 abline(v=2010, col=grey(0.5), lty=3)

 axis(1)
 
 axis(2, las=1, at=c(121, 121+15, 152, 152+15, 182), labels=c('1 May', '15 May', '1 June', '15 June', '1 July'))
 mtext(side=1, 'year', line=2.5, cex=axes.labels.cex*0.8)

 abline(h=121, col=grey(0.5))
 abline(h=152, col=grey(0.5))
 abline(h=182, col=grey(0.5))

 box()
#################
# Now the phenologies,

# first come lines

   lm_snow<-lm(yday~Yr, data=subset(Snow, Yr %in% c(1994:2016)))
   abline(lm_snow, col=Snow_global_color, lwd=2)
   
   # Tipula
   lm_tipula<-lm(yday~Yr, data=subset(Tipula, Region=='South'))
   abline(lm_tipula, col=Tipula_color, lwd=2)
   
   # Clutches
   lm_nests<-lm(yday~Yr, data=subset(Nests, Region=='South')) 
   abline(lm_nests, lwd=2, col=Nest_color)
  
   # Arrivals Taimyr
   lm_arr_t<-lm(yday~Yr, data=subset(Arr_Taimyr,  Yr %in% c(1994:2016)))
   abline(lm_arr_t,  col=Khat_arr_color, lwd=2)

   # Arrivals Wadden
   lm_arr_w<-lm(yday~Yr, data=subset(Arr_Wadden,  Yr %in% c(1994:2016)))
   abline(lm_arr_w, col=Arr_WZ_col, lwd=2)
   
   
Snow<-subset(Snow, Yr>=1994 & Yr<=2016)
  for (i in 1:nrow(Snow)) {
      points(yday~Yr,  data=Snow[i,], bg=Snow_global_color, cex=point_cex, pch=21,col=grey(0.4), lwd=point_lwd)
     #text(y=Snow$yday[i], x=Snow$Yr[i], 
	 #      labels=substr(Snow$Yr[i], 3,4) , col='white', cex=font_cex)
   }

Tipula_South<-subset(Tipula, Region=='South')
  for (i in 1:nrow(Tipula_South)) {
      points(yday~Yr,  data=Tipula_South[i,], bg=Tipula_color, cex=point_cex, pch=21,col=grey(0.4), lwd=point_lwd)
     #text(y=Tipula_South$yday[i], x=Tipula_South$Yr[i], 
	 #      labels=substr(Tipula_South$Yr[i], 3,4) , col='white', cex=font_cex)
   }

Nests_South<-subset(Nests, Region=='South')
  for (i in 1:nrow(Nests_South)) {
      points(yday~Yr,  data=Nests_South[i,], bg=Nest_color, cex=point_cex, pch=21,col=grey(0.4), lwd=point_lwd)
     #text(y=Nests_South$yday[i], x=Nests_South$Yr[i], 
	 #      labels=substr(Nests_South$Yr[i], 3,4) , col='white', cex=font_cex)
   }

Arr_Taimyr<-subset(Arr_Taimyr, Yr>=1994 & Yr<=2016)
  for (i in 1:nrow(Arr_Taimyr)) {
      points(yday~Yr,  data=Arr_Taimyr[i,], bg=Khat_arr_color, cex=point_cex, pch=21,col=grey(0.4), lwd=point_lwd)
     #text(y=Arr_Taimyr$yday[i], x=Arr_Taimyr$Yr[i], 
	 #      labels=substr(Arr_Taimyr$Yr[i], 3,4) , col='white', cex=font_cex)
   }

   
Arr_Wadden<-subset(Arr_Wadden, Yr>=1994 & Yr<=2016)
  for (i in 1:nrow(Arr_Wadden)) {
      points(yday~Yr,  data=Arr_Wadden[i,], bg=Arr_WZ_col, cex=point_cex, pch=21,col=grey(0.4), lwd=point_lwd)
     #text(y=Arr_Wadden$yday[i], x=Arr_Wadden$Yr[i], 
	 #      labels=substr(Arr_Wadden$Yr[i], 3,4) , col='white', cex=font_cex)
   }

  box()

# panel B
plot(median~Years, data=Predicted_densities, ylim=c(7000, 27000),
     type='n', las=1, ylab='', axes=FALSE, xlab='', xlim=c(1993, 2017))

abline(h=15000,  col=grey(0.5), lwd=1)	 
abline(h=25000,  col=grey(0.5), lty=2)	 
abline(h=c(10000, 20000),  col=grey(0.5), lty=3)	 
abline(h=15000,  col=grey(0.5), lty=2)	 
abline(v=2005, lty=2, col=grey(0.5))	 

 abline(v=1995, col=grey(0.5))
 abline(v=2015, col=grey(0.5))
 abline(v=2005, col=grey(0.5), lty=2)
 abline(v=2000, col=grey(0.5), lty=3)
 abline(v=2010, col=grey(0.5), lty=3)

 axis(1)
 mtext(side=1, 'year', line=2.5, cex=axes.labels.cex*0.8)
 axis(2, at=seq(10000, 25000, by=5000), label=seq(10000, 25000, by=5000)/1000, las=1)
 mtext(side=2, 'count (x1000)', line=2.5, cex=axes.labels.cex*0.8)

lines(x=Predicted_densities$Years, Predicted_densities$ucl, lty=2)
lines(x=Predicted_densities$Years, Predicted_densities$lcl, lty=2)
lines(median~Years, data=Predicted_densities, lwd=2)
	 
points(rowSums(y.matrix)~ Years,  pch=21, cex=point_cex, bg=Color_BA,
      col=grey(0.4),  lwd=point_lwd)
#text(y=rowSums(y.matrix), x=Years, labels=substr(Years, 3,4), col='white', cex=font_cex)
box()
   
if (Save_pdf) dev.off()   
```

## 9. Trends in data

### 9.1 load data
```{r}
   # read Snow
   Snowmelt<-read.csv('./results/Snow_remote.csv', as.is=TRUE)
   # read arrivals to Wadden Sea (predicted by arrival model)
   Arrivals_WZ<-read.csv('./results/Arrivals_migration_model.csv')
   # read Mauritania counts model resutls
   Counts_model<-readRDS('./results/Mauritania_counts_model.RDS')

if (Use_local_data) {
   # read breeding data
   Nests<-read.csv('./data/Nests.csv', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('./data/Tipula.csv', as.is=TRUE)
   # read arrivals to Khatanga
   Arr_Taimyr<-read.csv('./data/Arrivals_Khat.csv', as.is=TRUE)
   # read raw counts
   Counts<-read.csv('./data/Counts_Mauritania.csv', as.is=TRUE)
} else {
   # read breeding data
   Nests<-read.csv('https://git.io/vXu3y', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('https://git.io/vXu3x', as.is=TRUE)
   # read arrivals to Khatanga
   Arr_Taimyr<-read.csv('https://git.io/vXusf', as.is=TRUE)
   # read raw counts
   Counts<-read.csv('https://git.io/vXuL5')
}
```

### 9.2 Merge data
```{r}
   tmp<-merge(Arrivals_WZ[,1:2], Snowmelt[,c(1,2,3)], all=TRUE)
   names(tmp)[2:4]<-c('Arrivals_WZ', 'Snowmelt_global', 'Snowmelt_local')
   tmp<-merge(tmp, Arr_Taimyr[,c(1,3)], all=TRUE)
   names(tmp)[5]<-'Arr_T'

   tmp<-merge(tmp, subset(Tipula, Region=='South', select=c('Yr', 'yday')), all=TRUE)
   names(tmp)[6]<-'Tipula'

   Data_all<-subset(tmp, Yr>1992 & Yr<2017)
   Data_all$Ref_time<-(Data_all$Arr_T - Data_all$Arrivals_WZ-5.5)
   Nests_m<-merge(Nests[Nests$Region=='South',1:3], Snowmelt[,c(1:3)], all.x=TRUE)
   
   Areas<-sort(unique(Counts$Area))
   Years<-seq( min(unique(Counts$Yr)), max(unique(Counts$Yr)), 1)
   y.matrix<-matrix(ncol=length(Areas), nrow= length(Years))
   for (i in 1:nrow(Counts)) {
      y.matrix[which(Years==Counts$Yr[i]), which(Areas==Counts$Area[i])]<-Counts$Count[i]
   }
   Predicted_densities<-as.data.frame(cbind(Years, 
      t(apply(Counts_model$BUGSoutput$sims.list$n_total, 2,
      FUN=function(x) quantile(x, probs =c(0.025, 0.5, 0.975))))))
   names(Predicted_densities)[2:4]<-c("lcl", "median","ucl")
```

### 9.3 Linear models results (slopes and P-values)
```{r}
M_snow<-lm(Snowmelt_global~Yr, data=Data_all)
summary(M_snow)
M_snow_a<-lm(Snowmelt_global~1, data=Data_all)
anova(M_snow, M_snow_a)

summary(lm(Snowmelt_local~Yr, data=Data_all))
 
M_tipula_snow<-lm(Tipula~Snowmelt_local, data=Data_all)
summary(M_tipula_snow)
M_tipula_snow_a<-lm(Tipula~1, data=Data_all)
anova(M_tipula_snow,M_tipula_snow_a)

M_tipula<-lm(Tipula~Yr, data=Data_all)
summary(M_tipula)
M_tipula_a<-lm(Tipula~1, data=Data_all)
anova(M_tipula, M_tipula_a)

summary(lm(Tipula~Snowmelt_local, data=Data_all))
M_tipula<-lm(Tipula~Yr, data=Data_all)
summary(M_tipula)
M_tipula_a<-lm(Tipula~1, data=Data_all)
anova(M_tipula, M_tipula_a)

M_nests<-lm(yday~Yr, data=subset(Nests, Region=='South'))
summary(M_nests)
M_nests_a<-lm(yday~1, data=subset(Nests, Region=='South'))
anova(M_nests, M_nests_a)

M_nests_snow<-lm(yday~jdate50_south, data=Nests_m)
summary(M_nests_snow)
M_nests_snow_a<-lm(yday~1, data=Nests_m)
anova(M_nests_snow,M_nests_snow_a)

M_arr_T_snow<-lm(Arr_T ~Snowmelt_local, data=Data_all)
summary(M_arr_T_snow)
M_Arr_Ta<-lm(Arr_T ~1, data=Data_all)
anova(M_Arr_Ta, M_arr_T_snow)

summary(lm(yday~jdate50, data=Nests_m))

M_Arr_wS<-lm(Arrivals_WZ ~ Yr, data=Data_all)
summary(M_Arr_wS)
M_Arr_wSa<-lm(Arrivals_WZ ~ 1, data=Data_all)
anova(M_Arr_wS, M_Arr_wSa)

summary(lm(Arrivals_WZ ~ Snowmelt_global, data=Data_all))
summary(lm(Ref_time ~ Snowmelt_global, data=Data_all))
M_Ref_t<-lm(Ref_time ~ Yr, data=Data_all)
M_Ref_ta<-lm(Ref_time ~ 1, data=Data_all)
anova(M_Ref_t, M_Ref_ta)
summary(lm(Ref_time ~ Yr, data=Data_all))
```

## 10. Plot Figure 2 Refuelling time - refuelling slope - godwit survival - lugworms

### 10.1 Load data
```{r}
   fuelling_model<-readRDS('./results/fuelling_model.RDS')
   # read arrivals to Wadden Sea (predicted by arrival model)
   Arr_Wadden<-read.csv(file='./results/Arrivals_migration_model.csv')   
   
   Fuelling_slopes<-read.csv('./results/Fuelling_slopes.csv')

   Res<-readRDS('./results/survival_result.RDS')
   Res_adj<-adjust.chat(Res, chat=1.1186307)
   Model<-Res_adj[[3]]
   
if (Use_local_data) {
      # read arrivals to Khatanga
      Arr_Taimyr<-read.csv('./data/Arrivals_Khat.csv', as.is=TRUE)
      Lugworms<-read.csv('./data/Lugworms.csv')
} else {
     # read arrivals to Khatanga
     Arr_Taimyr<-read.csv('https://git.io/vXusf', as.is=TRUE)
     Lugworms<-read.csv('https://git.io/vXESR')
}
# No trend in lugworms:
   summary(lm(lugworms_ad~Yr, data=subset(Lugworms, Yr>=1994)))
# Average density:
   summary(lm(lugworms_ad~1, data=subset(Lugworms, Yr>=1994)))
```

### 10.2 Prepare data
```{r}
   Arr_Taimyr$Date<-as.Date(Arr_Taimyr$Date, tz='GMT', format='%Y-%m-%d' )
   Arr_Taimyr$Departure<-Arr_Taimyr$yday-5.5
   names(Arr_Wadden)[2]<-'yday'
   Stayovers<-merge(Arr_Wadden,
        Arr_Taimyr[,-which(names(Arr_Taimyr)=='yday')], by='Yr')
   Stayovers$Stayover<- Stayovers$Departure- Stayovers$yday
   Stayovers<-merge(Stayovers, subset(Lugworms, Yr>1994), all.x=TRUE)
   Stayovers<-merge(Stayovers, Fuelling_slopes, all=TRUE)
   
      Stayover_2_sexes<- rbind(
        data.frame(Yr=Stayovers$Yr,
           lugworms_ad=Stayovers$lugworms_ad,
		   Sex='f',           
	       Fuelling_slope=Stayovers$Fuelling_slope_females, 
           Fuelling_slope_predicted=Stayovers$Fuelling_slope_females_predicted),
        data.frame(Yr=Stayovers$Yr, 
		   lugworms_ad=Stayovers$lugworms_ad,
           Sex='m',
		   Fuelling_slope=Stayovers$Fuelling_slope_males, 
		   Fuelling_slope_predicted=Stayovers$Fuelling_slope_males_predicted))
          
```
Some regressions over year
```
Stayover_2_sexes$SexM<-factor(as.character(Stayover_2_sexes$Sex), levels=c('m', 'f'), labels=c('m', 'f'))
summary(lm(Fuelling_slope~Yr*Sex, data=Stayover_2_sexes))

M1<-lm(Stayover~Yr, data=(Stayovers))
Stopover_before_now<-predict(M1, newdata=data.frame(Yr=c(1995, 2015)))
M3a<-lm(Fuelling_slope~Yr+Sex, data=Stayover_2_sexes)
summary(M3a)
M3b<-lm(Fuelling_slope~Yr*Sex, data=Stayover_2_sexes)
summary(M3b)
anova(M3a, M3b)
M3c<-lm(Fuelling_slope~Sex, data=Stayover_2_sexes)
anova(M3a, M3c)

M4<-lm(Fuelling_slope_females~Yr, data=Stayovers)
Slope_females_before_now<-predict(M4, newdata=data.frame(Yr=c(1995, 2015)))

M5<-(lm(Stayover~Fuelling_slope_females, data=Stayovers))
M6<-(lm(Stayover~Fuelling_slope_males, data=Stayovers))

M7<-lm(lugworms_ad~Yr, data=Lugworms)
M7a<-lm(lugworms_ad~1, data=Lugworms)
summary(M7)
anova(M7, M7a)

M8<-lm(Fuelling_slope~lugworms_ad*Sex, data=Stayover_2_sexes)
summary(M8)
M8a<-lm(Fuelling_slope~lugworms_ad+Sex, data=Stayover_2_sexes)
anova(M8, M8a)
M8b<-lm(Fuelling_slope~Sex, data=Stayover_2_sexes[-c(1,5,23,27),])
anova(M8a, M8b)
summary(M8a)
```
Create grid for prediction
```{r}
Scale_stopover<-scale(log(Stayovers$Stayover))
Scale_females<-scale(log(Stayovers$Fuelling_slope_females))
Scale_males<-scale(log(Stayovers$Fuelling_slope_males))

Prediction.matrix<-expand.grid(log_fuelling_slope=seq(1.25-1.717, 2.35-1.717, by=0.001),
                               log_Stopover=seq(2.75, 3.6, by=0.001)-attr(Scale_stopover,"scaled:center"))

Design_females<-matrix(nrow=nrow(Prediction.matrix), ncol=20, data=0)
Design_females[,1]<-1
Design_females[,2]<-1
Design_females[,3]<-Prediction.matrix$log_fuelling_slope
Design_females[,4]<-Prediction.matrix$log_Stopover

Design_males<-matrix(nrow=nrow(Prediction.matrix), ncol=20, data=0)
Design_males[,1]<-1
Design_males[,2]<-1
Design_males[,3]<-Prediction.matrix$log_fuelling_slope
Design_males[,4]<-Prediction.matrix$log_Stopover
Design_males[,5]<-1
Design_males[,6]<-Prediction.matrix$log_Stopover

Prediction.matrix$Prediction_females<-
     plogis(Design_females%*%as.matrix(summary(Model)$beta[,1, drop=FALSE]))
Prediction.matrix$Prediction_males<-
     plogis(Design_males%*%as.matrix(summary(Model)$beta[,1, drop=FALSE]))
Prediction.matrix$fuelling_slope_females<-
     exp(Prediction.matrix$log_fuelling_slope+attr(Scale_females,"scaled:center"))
#Prediction.matrix$Stopover<-exp(Prediction.matrix$log_Stopover)
Prediction.matrix$Stopover<-exp(Prediction.matrix$log_Stopover +attr(Scale_stopover,"scaled:center"))
Prediction.matrix$fuelling_slope_males<-
     exp(Prediction.matrix$log_fuelling_slope+attr(Scale_males,"scaled:center"))

M3<-lm(Fuelling_slope_males~Yr, data=Stayovers)
Slope_males_before_now<-predict(M3, newdata=data.frame(Yr=c(1995, 2015)))

Design_females_s<-matrix(nrow=2, ncol=20, data=0)
Design_females_s[,1]<-1
Design_females_s[,2]<-1
Design_females_s[,3]<-log(Slope_females_before_now)-attr(Scale_females,"scaled:center")
Design_females_s[,4]<-log(Stopover_before_now)-attr(Scale_stopover,"scaled:center")

Design_males_s<-matrix(nrow=2, ncol=20, data=0)
Design_males_s[,1]<-1
Design_males_s[,2]<-1
Design_males_s[,3]<-log(Slope_males_before_now)-attr(Scale_males,"scaled:center")
Design_males_s[,4]<-log(Stopover_before_now)-attr(Scale_stopover,"scaled:center")
Design_males_s[,5]<-1
Design_males_s[,6]<-log(Stopover_before_now)-attr(Scale_stopover,"scaled:center")
```

### 10.3 plot

```{r fig.width=9, fig.height=12}

Colors<-colorRampPalette(c("#b2182b",
                           "#d6604d",
                           "#f4a582",
                           "#fddbc7",
                           "#f7f7f7",
                           "#d1e5f0",
                           "#92c5de",
                           "#4393c3",
                           "#2166ac"), bias=0.5)
                           
Fem_col='#338E77'
Mal_col=grey(0.5)
                           
axes.labels.cex=1.2
                          
if (Save_pdf) pdf(file='Figure 2.pdf', useDingbats=FALSE, width=9, height=12)

 m <- rbind(c(1, 2, 3),
            c(1, 2, 3),
            c(9, 9, 9),
            c(4, 9, 5), 
            c(4, 9, 5),
            c(6, 9, 7),
            c(6, 9, 7),
            c(9, 9, 8))
 m
 LM<-layout(m)

#--------------------------------------------------------
# Panel 1 - Refuelling Time (stayover) by years
par(mar=c(3, 5,2,1 ))

plot(Stayovers$Stayover~Stayovers$Yr, type='p', ylim=c(17, 35),  ylab='',
     las=1, xlim=c(1992, 2018), xlab='', cex=2, axes=F, yaxs='i', pch=21,
	 col='white', bg='black')
	 
axis(1, cex.axis=axes.labels.cex)
axis(4, labels=FALSE)

par(xpd=TRUE)
mtext(side=1, 'year', line=3, cex=axes.labels.cex)
par(xpd=FALSE)

axis(2, cex.axis=axes.labels.cex, las=1)
mtext(side=2, 'refuelling time (d)', line=3,cex=axes.labels.cex,)
abline(lm(Stayover~Yr, data=Stayovers), lwd=2)
# 95%CI
XX<-seq(1992,2018, by=0.1)
Pred<-predict(M1, newdata=data.frame(Yr=XX), se.fit=TRUE)
UCI<-Pred$fit+1.96*Pred$se.fit
LCI<-Pred$fit-1.96*Pred$se.fit
lines(UCI~XX, lty=2)
lines(LCI~XX, lty=2)

box()
abline(h=Stopover_before_now)

#---------------------------------------
# panel 2 
# survival panel for females.
par(mar=c(4, 5,2,2 ))
Prediction.matrix_cur<-subset(Prediction.matrix,  Stopover>=17 & 
                      Stopover<=35 & 
					  fuelling_slope_females<=11.5 &
					  fuelling_slope_females>=4)
Female_Image<-as.image(x=Prediction.matrix_cur[,c(5,6)], Z=Prediction.matrix_cur$Prediction_females)

plot(0,0, type='n', xaxt='n', yaxt='n', xlab='', ylab='', bty='n')  # make an empty plot

par(xpd=TRUE)
#mtext(side=2, 'refuelling time (d)', line=3,cex=axes.labels.cex)
mtext("female refuelling rate (g/d)", side=1, line=4, cex=axes.labels.cex)
par(xpd=FALSE)

par(new=T)
par(mar=c(3, 2,2,2 ))

image(Female_Image, 
          col=Colors(256), xlab='', ylab='', las=1, ylim=c(17,35), xlim=c(4,11.5),
	  cex.axis=axes.labels.cex)
axis(4, labels=FALSE)

contour(Female_Image,add=T, levels=plogis(Design_females_s%*%as.matrix(summary(Model)$beta[,1, drop=FALSE]))[1],
       lwd=3, col=grey(0.5),
	   labels=round(plogis(Design_females_s%*%as.matrix(summary(Model)$beta[,1, drop=FALSE]))[1],2),
	   labcex = 1)

contour(Female_Image,add=T, levels=c(0.8, 0.85, 0.9, 0.95), col='white', labcex=1)
box()

#-------------------------------------
# Panel 3 - the mail surface

Prediction.matrix_cur_males<-subset(Prediction.matrix,  fuelling_slope_males>=3.5 &
                             Stopover<=35 & fuelling_slope_males<=8.5 & Stopover>17)

Male_Image<-as.image(x=Prediction.matrix_cur_males[,c(7,6)],
            Z=Prediction.matrix_cur_males$Prediction_males, nx=200, ny=200)

plot(0,0, type='n', xaxt='n', yaxt='n', xlab='', ylab='', bty='n')  # make an empty plot
par(xpd=TRUE)
mtext("male refuelling rate (g/d)", side=1, line=3, cex=axes.labels.cex)
par(xpd=FALSE)

par(new=T)
par(mar=c(3, 2,2,2 ))

image(Male_Image, 
          col=Colors(256), xlab='', ylab='', las=1, ylim=c(17,35), xlim=c(3.5,8.5),
	  cex.axis=axes.labels.cex)

contour(Male_Image, add=T, levels=plogis(Design_males_s%*%as.matrix(summary(Model)$beta[,1, drop=FALSE]))[1],
        lwd=3, col=grey(0.5),
		labels=round(plogis(Design_males_s%*%as.matrix(summary(Model)$beta[,1, drop=FALSE]))[1],2),
		labcex = 1)

contour(Male_Image,add=T, levels=c(0.8, 0.85, 0.9, 0.95), col='white', labcex=1)
	 
box()

#---------------------------------------------------------
# panel 4 refuelling rates over years for females
par(mar=c(4, 5,2,2 ))

plot(Fuelling_slope~Yr, data=Stayover_2_sexes, type='n',  ylab='',
     las=1, xlim=c(1992, 2018), xlab='', axes=F,  cex=2, pch=21,
	 bg=Fem_col, col='white', las=1, ylim=c(3.5,10.5))
axis(1, cex.axis=axes.labels.cex)
axis(4, labels=FALSE)

axis(2, las=1, cex.axis=axes.labels.cex)
mtext(side=2, 'refuelling rate (g/d)', line=3,cex=axes.labels.cex)

XX<-seq(1990,2019, by=0.1)

Pred_f<-predict(M3b, newdata=data.frame(Yr=XX, Sex='f'), se.fit=TRUE)
UCI_f<-Pred_f$fit+1.96*Pred_f$se.fit
LCI_f<-Pred_f$fit-1.96*Pred_f$se.fit

Pred_m<-predict(M3b, newdata=data.frame(Yr=XX, Sex='m'), se.fit=TRUE)
UCI_m<-Pred_m$fit+1.96*Pred_m$se.fit
LCI_m<-Pred_m$fit-1.96*Pred_m$se.fit

lines(Pred_f$fit~XX, lwd=2, col=Fem_col)
lines(UCI_f~XX, lty=2, col=Fem_col)
lines(LCI_f~XX, lty=2, col=Fem_col)

abline(h=10.1)
abline(h=predict(M3b, newdata=data.frame(Yr=2015, Sex='f')))
abline(h=predict(M3b, newdata=data.frame(Yr=1995, Sex='f')))

points(Fuelling_slope~Yr, data=subset(Stayover_2_sexes, Sex=='f'),
     cex=2, pch=21, bg=Fem_col, col='white')
     
box()

#---------------------------------------
# Panel 5 is the lugworm panel for females
par(mar=c(4, 5,2,2 ))
plot(Fuelling_slope~lugworms_ad, data=Stayover_2_sexes,
     ylim=c(3.5, 10.5), xlim=c(7, 35), ylab='',
     xlab='' ,las=1, type='n', axes=FALSE)
	 
axis(2, cex.axis=axes.labels.cex, las=1)
mtext(side=2, 'refuelling rate (g/d)', line=3, cex=axes.labels.cex)

axis(1, las=1, cex.axis=axes.labels.cex)

abline(h=10.1)
abline(v=34.6)

XX<-seq(min(Stayover_2_sexes$lugworms_ad, na.rm=TRUE)-5, max(Stayover_2_sexes$lugworms_ad, na.rm=TRUE)+17, 0.1)

Alpha_pred_f<-predict(M8a, newdata=data.frame(lugworms_ad=XX, Sex='f'), se.fit=TRUE)
Alpha_pred_m<-predict(M8a, newdata=data.frame(lugworms_ad=XX, Sex='m'), se.fit=TRUE)

Alhpa_pred_f_df<-data.frame(estimate=Alpha_pred_f$fit, 
                            lci=Alpha_pred_f$fit-1.96*Alpha_pred_f$se.fit,
                            uci=Alpha_pred_f$fit+1.96*Alpha_pred_f$se.fit)
Alhpa_pred_m_df<-data.frame(estimate=Alpha_pred_m$fit,
                            lci=Alpha_pred_m$fit-1.96*Alpha_pred_f$se.fit,
                            uci=Alpha_pred_m$fit+1.96*Alpha_pred_m$se.fit)

lines(Alhpa_pred_f_df$uci~XX,  lty=2, col=Fem_col)
lines(Alhpa_pred_f_df$estimate~XX, lwd=2, col=Fem_col)
lines(Alhpa_pred_f_df$lci~XX, lty=2, col=Fem_col)

points(Fuelling_slope~lugworms_ad, data=subset(Stayover_2_sexes, Sex=='f'),
   pch=21, cex=2, bg=Fem_col, col='white')
   
box()

#---------------------------------------------------------
# panel 6 should be the one with refuelling rates
# we now plot males

par(mar=c(4, 5,2,2 ))

plot(Fuelling_slope~Yr, data=Stayover_2_sexes, type='n',  ylab='',
     las=1, xlim=c(1992, 2018), xlab='', axes=F, cex=2, pch=21,
	 bg=Fem_col, col='white', las=1, ylim=c(3.5,10.5))
	 .
axis(1, cex.axis=axes.labels.cex)
axis(3, labels=FALSE)
axis(4, labels=FALSE)

par(xpd=TRUE)
mtext(side=1, 'year', line=3, cex=axes.labels.cex)
par(xpd=FALSE)

axis(2, las=1, cex.axis=axes.labels.cex)
mtext(side=2, 'refuelling rate (g/d)', line=3,cex=axes.labels.cex)

XX<-seq(1991,2019, by=0.1)

Pred_f<-predict(M3b, newdata=data.frame(Yr=XX, Sex='f'), se.fit=TRUE)
UCI_f<-Pred_f$fit+1.96*Pred_f$se.fit
LCI_f<-Pred_f$fit-1.96*Pred_f$se.fit

Pred_m<-predict(M3b, newdata=data.frame(Yr=XX, Sex='m'), se.fit=TRUE)
UCI_m<-Pred_m$fit+1.96*Pred_m$se.fit
LCI_m<-Pred_m$fit-1.96*Pred_m$se.fit

lines(Pred_m$fit~XX, lwd=2, col=Mal_col)
lines(UCI_m~XX, lty=2, col=Mal_col)
lines(LCI_m~XX, lty=2, col=Mal_col)

abline(h=6.6)
abline(h=predict(M3b, newdata=data.frame(Yr=2015, Sex='m')))
abline(h=predict(M3b, newdata=data.frame(Yr=1995, Sex='m')))

points(Fuelling_slope~Yr, data=subset(Stayover_2_sexes, Sex=='m'),
     cex=2, pch=21, bg=Mal_col, col='white')     
box()

#---------------------------------------
# Panel 7 is the lugworm panel for males

par(mar=c(4, 5,2,2 ))
plot(Fuelling_slope~lugworms_ad, data=Stayover_2_sexes,
     ylim=c(3.5, 10.5), xlim=c(7, 35), ylab='',
     xlab='' ,las=1, type='n', axes=FALSE)
	 
axis(2, cex.axis=axes.labels.cex, las=1)
axis(3, labels=FALSE)
mtext(side=2, 'refuelling rate (g/d)', line=3, cex=axes.labels.cex)
axis(1, las=1, cex.axis=axes.labels.cex)

XX<-seq(min(Stayover_2_sexes$lugworms_ad, na.rm=TRUE)-5, max(Stayover_2_sexes$lugworms_ad, na.rm=TRUE)+17, 0.1)

Alpha_pred_f<-predict(M8a, newdata=data.frame(lugworms_ad=XX, Sex='f'), se.fit=TRUE)
Alpha_pred_m<-predict(M8a, newdata=data.frame(lugworms_ad=XX, Sex='m'), se.fit=TRUE)

Alhpa_pred_f_df<-data.frame(estimate=Alpha_pred_f$fit,
                            lci=Alpha_pred_f$fit-1.96*Alpha_pred_f$se.fit,
                            uci=Alpha_pred_f$fit+1.96*Alpha_pred_f$se.fit)
Alhpa_pred_m_df<-data.frame(estimate=Alpha_pred_m$fit,
                            lci=Alpha_pred_m$fit-1.96*Alpha_pred_f$se.fit,
                            uci=Alpha_pred_m$fit+1.96*Alpha_pred_m$se.fit)

lines(Alhpa_pred_m_df$uci~XX,  lty=2, col=Mal_col)
lines(Alhpa_pred_m_df$estimate~XX, lwd=2, col=Mal_col)
lines(Alhpa_pred_m_df$lci~XX, lty=2, col=Mal_col)
abline(h=6.6)
abline(v=20.0)

points(Fuelling_slope~lugworms_ad, data=subset(Stayover_2_sexes, Sex=='m'),
   pch=21, cex=2, bg=Mal_col, col='white')
   
box()

# Panel 8 - lugworms hist

par(mar=c(4, 5,0,2 ))
hist(Stayovers$lugworms, breaks=seq(7.5, 22.5, by=2.5),
     main='', col=grey(0.9), las=1, ylab='', xlab='',
     xlim=c(7, 35), axes=FALSE )

axis(1,  cex.axis=axes.labels.cex)
axis(2,  cex.axis=axes.labels.cex, labels=c(0,2,4), at=c(0,2,4), las=1)
axis(3, labels=FALSE)

box()
mtext(side=1, 'lugworm density (ind./sq.m)', line=3, cex=axes.labels.cex)
mtext(side=2, 'frequency (years)', line=3, cex=axes.labels.cex)

if (Save_pdf) dev.off()
```

## 11. Figure 3 - the methods figure

### 11.1 load data

```{r}
if (Use_local_data) {
    sites_years_dates<-read.csv('./data/godwit_trektellen_seven_major_sites.csv',
                                as.is=TRUE)
    Arrivals_Khat<-read.csv('./data/Arrivals_Khat.csv', as.is=TRUE)
    Capture_data<-read.csv('./data/Capture_data.csv', as.is=TRUE)
} else {
   sites_years_dates<-read.csv('https://git.io/vXEBH', as.is=TRUE)
   Arrivals_Khat<-read.csv('https://git.io/vXusf', as.is=TRUE)
   Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
}

Arrivals_WZ<-read.csv('./results/Arrivals_migration_model.csv')
Arrival_weights<-read.csv('./results/Arrival_weights.csv')
Fueling_slopes<-read.csv('./results/Fuelling_slopes.csv')
```

### 11.2 Plot

```{r fig.width=6, fig.height=9} 
Year2plot<-1998
pdf(paste0('methods_plot_', Year2plot, '.pdf'), width=6, height=9, useDingbats=FALSE)
 m <- rbind(c(1,2,2), c(3, 4,4), c(3, 4,4), c(5,6,6), c(5,6,6))
 m
 layout(m)
mar.old<-par('mar')

plot.new()

#-----------------------------------------------------
# Panel 1  trektellen and phenology data..
mar.new<-mar.old
mar.new[1]<-1.5
mar.new[3]<-1.5
mar.new[2]<-0

par(mar=mar.new)
Xlabseq<-c('15-Apr', '1-May', '15-May', '1-June', '15-June')
Label_dates<-as.POSIXct(paste(Year2plot, Xlabseq, sep='-'), format='%Y-%d-%b', tz='UTC')
Label_jdates<-as.numeric(format(Label_dates, format='%j'))
xlims<-c(100, 170)

breaks=seq(105, 170, by=5)

cur_year<-subset(sites_years_dates, Year_real==Year2plot)
Totals<-aggregate(cur_year$Y, by=list(cur_year$Date), sum)
names(Totals)<-c( 'jdate', 'total')

hist(rep(Totals$jdate, Totals$total), xlim=xlims, axes=FALSE, 
     xlab='', ylab='', main='', freq=TRUE, breaks=seq(100, 170, by=5))
axis(1, labels=Xlabseq, at=Label_jdates)
axis(2, las=1, tcl=0.5, mgp=c(0, -3, 0),labels=seq(500, 2500, by=500),
     at=seq(500, 2500, by=500))

mtext('total count, n', side=2, line=0.5)
box(bty='l')

Arrival_Taimyr_cur<-subset(Arrivals_Khat, Yr==Year2plot)

abline(v=Arrival_Taimyr_cur$yday)
abline(v=Arrival_Taimyr_cur$yday-5.5)

Arrivals_WZ_cur<-subset(Arrivals_WZ, Yr==Year2plot)
abline(v=Arrivals_WZ_cur$arrival, col=grey(0.5))
abline(v=Arrivals_WZ_cur$arrival-Arrivals_WZ_cur$sigma, col=grey(0.8))
abline(v=Arrivals_WZ_cur$arrival+Arrivals_WZ_cur$sigma, col=grey(0.8))

par(mar=mar.old)

#-----------------------------------------------------------
# Panel 2 Vertical histogram of arrival mass

mar.new<-mar.old
mar.new[1]<-1.5
mar.new[2]<-0.5
mar.new[3]<-1
mar.new[4]<-1.5
par(mar=mar.new)

ylim_weights_f<-c(150, 550)

aggr_data_females_Cas<-subset(Capture_data,  Sex==2 &
                              Site == "Castricum" & Yr==Year2plot)

hs<-hist(aggr_data_females_Cas$Mass, breaks=seq(150, 550, by=25), plot=FALSE)

    plot (NA, type='n', axes=FALSE, yaxt='n',
          xlab='Captures, n', ylab=NA, main=NA,
          xlim=c(max(hs$counts), 0),
          ylim=ylim_weights_f, las=1)
mtext('mass, g', side=4, line=0)

   axis (1)
   rect(ybottom=c(hs$breaks[-length(hs$breaks)]),
        ytop=hs$breaks[-1], xleft=hs$counts, xright=0)

Arrivals_weights_cur<-subset(Arrival_weights, Yr==Year2plot)
abline(h=Arrivals_weights_cur$Female_arrival_weight, col=grey(0.5))
abline(h=Arrivals_weights_cur$Female_arrival_weight-
          Arrivals_weights_cur$Female_arrival_weight_sigma, col=grey(0.8))
abline(h=Arrivals_weights_cur$Female_arrival_weight+
          Arrivals_weights_cur$Female_arrival_weight_sigma, col=grey(0.8))

#---------------------------------------------------------
# Panel 3 female captures in the Wadden Sea

mar.new[4]<-mar.old[4]
mar.new[3]<-1
mar.new[2]<-0
par(mar=mar.new)

aggr_data_females_Wad<-subset(Capture_data,  Sex==2 &
                              Site != "Castricum" & Yr==Year2plot)
par(xpd=TRUE)
plot(Mass ~ yday, data=aggr_data_females_Wad, pch=19,
     xlim=xlims, ylim=ylim_weights_f, axes=FALSE, xlab='')
axis(2, las=1, tcl=0.5, mgp=c(0, -3, 0))
axis(1, labels=Xlabseq, at=Label_jdates)
box(bty='l')
par(xpd=FALSE)

Arrivals_WZ_cur<-subset(Arrivals_WZ, Yr==Year2plot)

abline(v=Arrivals_WZ_cur$arrival, col=grey(0.5))
abline(v=Arrivals_WZ_cur$arrival-Arrivals_WZ_cur$sigma, col=grey(0.8))
abline(v=Arrivals_WZ_cur$arrival+Arrivals_WZ_cur$sigma, col=grey(0.8))

Arrivals_weights_cur<-subset(Arrival_weights, Yr==Year2plot)
abline(h=Arrivals_weights_cur$Female_arrival_weight, col=grey(0.5))
abline(h=Arrivals_weights_cur$Female_arrival_weight-
       Arrivals_weights_cur$Female_arrival_weight_sigma, col=grey(0.8))
abline(h=Arrivals_weights_cur$Female_arrival_weight+
       Arrivals_weights_cur$Female_arrival_weight_sigma, col=grey(0.8))

Fueling_slopes_cur<-subset(Fueling_slopes, Yr==Year2plot)

Fuleling_intercept_females<-Arrivals_weights_cur$Female_arrival_weight-
       Fueling_slopes_cur$Fuelling_slope_females*Arrivals_WZ_cur$arrival

abline(a=Fuleling_intercept_females, b=Fueling_slopes_cur$Fuelling_slope_females)

#------------------------------------------------------------------------
# Panel 4 vertical histogram of arrival mass for males

mar.new<-mar.old
mar.new[2]<-0.5
mar.new[3]<-1
mar.new[4]<-1.5
par(mar=mar.new)

ylim_weights_m<-c(150, 550)
aggr_data_males_Cas<-subset(Capture_data,  Sex==1 & Site == "Castricum" & Yr==Year2plot)

hs<-hist(aggr_data_males_Cas$Mass, breaks=seq(150, 550, by=25), plot=FALSE)

    plot (NA, type='n', axes=FALSE, yaxt='n',
          xlab='', ylab=NA, main=NA,
          xlim=c(max(hs$counts), 0),
          ylim=ylim_weights_m, las=1)
   axis (1)
mtext('mass, g', side=4, line=0)
mtext('captures, n', side=1, line=3)
   rect(ybottom=c(hs$breaks[-length(hs$breaks)]), ytop=hs$breaks[-1],
        xleft=hs$counts, xright=0)
Arrival_weights<-read.csv('https://git.io/vXEbX')

Arrivals_weights_cur<-subset(Arrival_weights, Yr==Year2plot)
abline(h=Arrivals_weights_cur$Male_arrival_weight, col=grey(0.5))
abline(h=Arrivals_weights_cur$Male_arrival_weight-
          Arrivals_weights_cur$Memale_arrival_weight_sigma, col=grey(0.8))
abline(h=Arrivals_weights_cur$Male_arrival_weight+
          Arrivals_weights_cur$Male_arrival_weight_sigma, col=grey(0.8))

#----------------------------------------------------------------------------
# Panel 5 male captures in the Wadden Sea
mar.new[4]<-mar.old[4]
mar.new[3]<-1
mar.new[2]<-0
par(mar=mar.new)

aggr_data_males_Wad<-subset(Capture_data,  Sex==1 & Site != "Castricum" & Yr==Year2plot)
plot(Mass ~ yday, data=aggr_data_males_Wad, pch=19,
     xlim=xlims, ylim=ylim_weights_f, axes=FALSE, xlab='')
axis(2, las=1, tcl=0.5, mgp=c(0, -3, 0))
axis(1, labels=Xlabseq, at=Label_jdates)
mtext('date', side=1, line=3)

box(bty='l')

abline(v=Arrivals_WZ_cur$arrival, col=grey(0.5))
abline(v=Arrivals_WZ_cur$arrival-Arrivals_WZ_cur$sigma, col=grey(0.8))
abline(v=Arrivals_WZ_cur$arrival+Arrivals_WZ_cur$sigma, col=grey(0.8))

abline(h=Arrivals_weights_cur$Male_arrival_weight, col=grey(0.5))
abline(h=Arrivals_weights_cur$Male_arrival_weight-
          Arrivals_weights_cur$Male_arrival_weight_sigma, col=grey(0.8))
abline(h=Arrivals_weights_cur$Male_arrival_weight+
          Arrivals_weights_cur$Male_arrival_weight_sigma, col=grey(0.8))

Fuleling_intercept_males<-Arrivals_weights_cur$Male_arrival_weight-
          Fueling_slopes_cur$Fuelling_slope_males*Arrivals_WZ_cur$arrival

abline(a=Fuleling_intercept_males, b=Fueling_slopes_cur$Fuelling_slope_males)

par(mar=mar.old)

if (Save_pdf) dev.off()
```

## Figure 12 Supplementary Figures 1 and 2

I will just make a separate small figure for each year, that can be combinded if needed.

### 12.1 load data

```{r}
if (Use_local_data) {
    sites_years_dates<-read.csv('./data/godwit_trektellen_seven_major_sites.csv',
                                as.is=TRUE)
    Arrivals_Khat<-read.csv('./data/Arrivals_Khat.csv', as.is=TRUE)
    Capture_data<-read.csv('./data/Capture_data.csv', as.is=TRUE)
} else {
   sites_years_dates<-read.csv('https://git.io/vXEBH', as.is=TRUE)
   Arrivals_Khat<-read.csv('https://git.io/vXusf', as.is=TRUE)
   Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
}

Arrivals_WZ<-read.csv('./results/Arrivals_migration_model.csv')
Arrival_weights<-read.csv('./results/Arrival_weights.csv')
Fueling_slopes<-read.csv('./results/Fuelling_slopes.csv')
```

### 12.2 plot

```{r fig.width=4, fig.height=4.5}

Fem_col='#338E77'
Mal_col=grey(0.5)
Cex=0.8

for(Year2plot in 1996:2016) {

if (Save_pdf) pdf(paste0('methods_plot_small', Year2plot, '.pdf'), width=4, height=4.5, useDingbats=FALSE)

m <- rbind(c(1,2,2,2), c(3, 4,4,4), c(3, 4,4,4), c(5,6,6,6), c(5,6,6,6))
m
 layout(m)
mar.old<-par('mar')


par(mar=c(0,0,0,0))
plot(c(0,1), c(0,1), type='n', axes=FALSE, , xlab='', ylab='')
par(xpd=TRUE)
text( x=0.5, y=0.5, labels=Year2plot, cex=2, adj=c(0.5, NA))

par(xpd=FALSE)
par(mar=mar.old)

#--------------------------------
# Panel 1 trektellen and phenology data..
mar.new<-mar.old
mar.new[1]<-0.5
mar.new[3]<-1
mar.new[2]<-0

par(mar=mar.new)
Xlabseq<-c('15-Apr', '1-May', '15-May', '1-June')
Label_dates<-as.POSIXct(paste(Year2plot, Xlabseq, sep='-'), format='%Y-%d-%b', tz='UTC')
Label_jdates<-as.numeric(format(Label_dates, format='%j'))
xlims<-c(100, 165)

breaks=seq(105, 150, by=5)

cur_year<-subset(sites_years_dates, Year_real==Year2plot)
Totals<-aggregate(cur_year$Y, by=list(cur_year$Date), sum)
names(Totals)<-c( 'jdate', 'total')
hist(rep(Totals$jdate, Totals$total), xlim=xlims, axes=FALSE,
     xlab='', ylab='', main='', freq=TRUE, breaks=seq(100, 170, by=5))
axis(1, labels=Xlabseq, at=Label_jdates)

axis(2, las=1, tcl=0.5, mgp=c(0, -3, 0), )
mtext('total count, n', side=2, line=0.5, cex=Cex)

box(bty='l')

# vertical lines for estimates
Arrivals_WZ_cur<-subset(Arrivals_WZ, Yr==Year2plot)
abline(v=Arrivals_WZ_cur$arrival, col='#f47733', lwd=2)
abline(v=Arrivals_WZ_cur$arrival-Arrivals_WZ_cur$sigma, col='#f47733', lwd=2, lty=2)
abline(v=Arrivals_WZ_cur$arrival+Arrivals_WZ_cur$sigma, col='#f47733', lwd=2, lty=2)

par(mar=mar.old)

# Now I want to plot get the 
# the second one will be the arrival weights..

#-----------------------------------------------------------------------
# Panel B Females
# Vertcial histogram of counts...

mar.new<-mar.old
mar.new[1]<-2
mar.new[2]<-0.5
mar.new[3]<-2
mar.new[4]<-1.5
par(mar=mar.new)

ylim_weights_f<-c(150, 550)

aggr_data_females_Cas<-subset(Capture_data,  Sex==2 & Site == "Castricum" & Yr==Year2plot)

#hist(aggr_data_females_Cas$Mass, breaks=15, plot=TRUE)
hs<-hist(aggr_data_females_Cas$Mass, breaks=seq(150, 550, by=25), plot=FALSE)

#   par (fig=c(0.8,1.0,0.0,1.0), mar=mar.left)
    plot (NA, type='n', axes=FALSE, yaxt='n',
          xlab='Captures, n', ylab=NA, main=NA,
          xlim=c(max(hs$counts), 0),
          ylim=ylim_weights_f, las=1)
mtext('mass, g', side=4, line=0, cex=Cex)

   axis (1)
#   axis (4, las=1)
   rect(ybottom=c(hs$breaks[-length(hs$breaks)]), ytop=hs$breaks[-1], xleft=hs$counts, xright=0, border=Fem_col)
   #box(bty='l')
#Arrival_weights<-read.csv('./results/Arrival_weights.csv')
Arrival_weights<-read.csv('https://git.io/vXEbX')

Arrivals_weights_cur<-subset(Arrival_weights, Yr==Year2plot)
abline(h=Arrivals_weights_cur$Female_arrival_weight, col=Fem_col, lwd=2)
abline(h=Arrivals_weights_cur$Female_arrival_weight-
     Arrivals_weights_cur$Female_arrival_weight_sigma, col=Fem_col, lwd=2, lty=2)
abline(h=Arrivals_weights_cur$Female_arrival_weight+
     Arrivals_weights_cur$Female_arrival_weight_sigma, col=Fem_col, lwd=2, lty=2)

#--------------------------------------------------------------------
# Panel C capture data
# and now we want a plot with capture data..
# Females

mar.new[4]<-1.5
mar.new[3]<-2
mar.new[1]<-2

mar.new[2]<-0
par(mar=mar.new)

aggr_data_females_Wad<-subset(Capture_data,  Sex==2 & Site != "Castricum" & Yr==Year2plot)
par(xpd=TRUE)
plot(Mass ~ yday, data=aggr_data_females_Wad, pch=19,
     xlim=xlims, ylim=ylim_weights_f, axes=FALSE, xlab='', col=Fem_col)
axis(2, las=1, tcl=0.5, mgp=c(0, -3, 0))
axis(1, labels=Xlabseq, at=Label_jdates)
box(bty='l')
par(xpd=FALSE)

# and now the lines..
# 1. vertical lines from the trektellen

abline(v=Arrivals_WZ_cur$arrival, col='#f47733', lwd=2)
abline(v=Arrivals_WZ_cur$arrival-Arrivals_WZ_cur$sigma, col='#f47733', lwd=2, lty=2)
abline(v=Arrivals_WZ_cur$arrival+Arrivals_WZ_cur$sigma, col='#f47733', lwd=2, lty=2)

# 2. horizontal from Castricum

Arrivals_weights_cur<-subset(Arrival_weights, Yr==Year2plot)
abline(h=Arrivals_weights_cur$Female_arrival_weight, col=Fem_col, lwd=2)
abline(h=Arrivals_weights_cur$Female_arrival_weight-
       Arrivals_weights_cur$`, col=Fem_col, lwd=2, lty=2)
abline(h=Arrivals_weights_cur$Female_arrival_weight+
       Arrivals_weights_cur$Female_arrival_weight_sigma, col=Fem_col, lwd=2, lty=2)

# 3. regression line..
Fueling_slopes_cur<-subset(Fueling_slopes, Yr==Year2plot)

Fuleling_intercept_females<-Arrivals_weights_cur$Female_arrival_weight-
       Fueling_slopes_cur$Fuelling_slope_females*Arrivals_WZ_cur$arrival

abline(a=Fuleling_intercept_females, 
       b=Fueling_slopes_cur$Fuelling_slope_females, col=Fem_col, lwd=2)

#---------------------------------------------------------------
# Panel D Males
# Vertcial histogram of counts...

mar.new<-mar.old
mar.new[2]<-0.5
mar.new[3]<-0
mar.new[4]<-1.5
mar.new[1]<-4

par(mar=mar.new)

ylim_weights_m<-c(150, 550)

aggr_data_males_Cas<-subset(Capture_data,  Sex==1 & Site == "Castricum" & Yr==Year2plot)

#hist(aggr_data_females_Cas$Mass, breaks=15, plot=TRUE)
hs<-hist(aggr_data_males_Cas$Mass, breaks=seq(150, 550, by=25), plot=FALSE)

#   par (fig=c(0.8,1.0,0.0,1.0), mar=mar.left)
    plot (NA, type='n', axes=FALSE, yaxt='n',
          xlab='', ylab=NA, main=NA,
          xlim=c(max(hs$counts), 0),
          ylim=ylim_weights_m, las=1)
   axis (1)
mtext('mass, g', side=4, line=0,, cex=Cex)
mtext('captures, n', side=1, line=2, cex=Cex)

   rect(ybottom=c(hs$breaks[-length(hs$breaks)]),
        ytop=hs$breaks[-1], xleft=hs$counts, xright=0, border=Mal_col)

Arrivals_weights_cur<-subset(Arrival_weights, Yr==Year2plot)
abline(h=Arrivals_weights_cur$Male_arrival_weight, col=Mal_col, lwd=2)
abline(h=Arrivals_weights_cur$Male_arrival_weight+
         Arrivals_weights_cur$Male_arrival_weight_sigma, col=Mal_col, lwd=2, lty=2)
abline(h=Arrivals_weights_cur$Male_arrival_weight+
         Arrivals_weights_cur$Male_arrival_weight_sigma, col=Mal_col, lwd=2, lty=2)
#------------------------------------------
# Panel E male capture data
mar.new[4]<-1.5
mar.new[3]<-0
mar.new[2]<-0
mar.new[1]<-4
par(mar=mar.new)

aggr_data_males_Wad<-subset(Capture_data,  Sex==1 & Site != "Castricum" & Yr==Year2plot)

plot(Mass ~ yday, data=aggr_data_males_Wad, pch=19,
     xlim=xlims, ylim=ylim_weights_f, axes=FALSE, xlab='', col=Mal_col)
axis(2, las=1, tcl=0.5, mgp=c(0, -3, 0))
axis(1, labels=Xlabseq, at=Label_jdates)
mtext('date', side=1, line=2,cex=Cex)

box(bty='l')

# 1. vertical lines from the trektellen

abline(v=Arrivals_WZ_cur$arrival, col='#f47733', lwd=2)
abline(v=Arrivals_WZ_cur$arrival-Arrivals_WZ_cur$sigma, col='#f47733', lwd=2, lty=2)
abline(v=Arrivals_WZ_cur$arrival+Arrivals_WZ_cur$sigma, col='#f47733', lwd=2, lty=2)

# 2. horizontal from Castricum
abline(h=Arrivals_weights_cur$Male_arrival_weight, col=Mal_col, lwd=2)
abline(h=Arrivals_weights_cur$Male_arrival_weight-
         Arrivals_weights_cur$Male_arrival_weight_sigma, col=Mal_col, lwd=2, lty=2)
abline(h=Arrivals_weights_cur$Male_arrival_weight+
         Arrivals_weights_cur$Male_arrival_weight_sigma, col=Mal_col, lwd=2, lty=2)

# 3. regression line..
Fuleling_intercept_males<-Arrivals_weights_cur$Male_arrival_weight-Fueling_slopes_cur$Fuelling_slope_males*Arrivals_WZ_cur$arrival

abline(a=Fuleling_intercept_males, b=Fueling_slopes_cur$Fuelling_slope_males,
       col=Mal_col, lwd=2)

par(mar=mar.old)

if (Save_pdf) dev.off()
}
```

## References

1. Bijleveld, A. I. et al. Designing a benthic monitoring programme with multiple conflicting objectives. Methods Ecol. Evol. 3, 526–536 (2012).<a id="bijleveld"></a>
1. Brown, R. D. & Robinson, D. A. Northern Hemisphere spring snow cover variability and change over 1922-2010 including an assessment of uncertainty. The Cryosphere 5, 219-229 (2011).<a id="brown-robinson"></a>
1. Compton, T. J. et al. Distinctly variable mudscapes: Distribution gradients of intertidal macrofauna across the Dutch Wadden Sea. J. Sea Res. 82, 103–116 (2013).<a id="compton"></a>
1. van Gils, J. A. et al. Body shrinkage due to Arctic warming reduces red knot fitness in tropical wintering range. Science 352, 819-821 (2016).<a id="van-gils"></a>
1. Kéry, M. & Schaub, M. Bayesian population analysis using WinBUGS a hierarchical perspective. (Academic Press, 2012).<a id="kery-schaub"></a>
1. Laake, J. L. RMark: An R interface for analysis of capture-recapture data with MARK. 25 (Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv., 2013).<a id="laake"></a>
1. Lappo, E., Tomkovich, P. & Syroechkovskiy, E. Atlas of breeding waders in the Russian Arctic. (2012).<a id="lappo"></a>
1. Lebreton, J.-D., Burnham, K. P., Clobert, J. & Anderson, D. R. Modeling survival and testing biological hypotheses using marked animals: a unified approach with case studies. Ecol. Monogr. 62, 67-118 (1992).<a id="lebreton"></a>
1. Lindén, A. & Mäntyniemi, S. Using the negative binomial distribution to model overdispersion in ecological count data. Ecology 92, 1414-1421 (2011).<a id="lindén-mäntyniemi"></a>
1. Plummer, M. JAGS: A program for analysis of Bayesian graphical models using Gibbs sampling. (2003).<a id="plummer"></a>
1. Su, Y.-S. & Masanao Yajima. R2jags: Using R to Run 'JAGS'. (2015).<a id="su-yahima"></a>
1. White, G. C. & Burnham, K. P. Program MARK: survival estimation from populations of marked animals. Bird Study 46, S120-S139 (1999).<a id="white"></a>


P.S. The html file from this markdown can be recereated with folloing code
```{r eval=FALSE}
download.file('https://git.io/vXaM6', 'tmp.rmd', cacheOK = FALSE)
rmarkdown::render('tmp.rmd', output_format = 'html_document',
        output_options=list(toc=TRUE, toc_float=list(collapsed=FALSE)), 
        encoding='utf-8')
```
