# Supplementary code to 'Food abundance at temperate shores can mitigate Arctic climate change effects in a migratory bird' by Rakhimberidev et al. to be submitted

_code by Eldar Rakhimberdiev_

You might enjoy [html version of this supplementary](http://htmlpreview.github.io/?https://github.com/eldarrak/Godwits_worms_and_climate_change/blob/master/code/All_code.html?raw=true).

## 0. Set up output and run options
```{r}
set.seed(123)
```
### 0.1 To run or to load?
Parts of this code take time to run, so if you want to go through examples fast and do not want to install all the software
```{r}
Run_everything=FALSE # Change to TRUE if you want run everything by your computer
```

### 0.2 Online or local data?
This script can operate online or local data. If `Use_local_data` set to TRUE working directory expected to have folders `data`, `results`.
```{r}
Use_local_data=FALSE # Change to TRUE if you want to use local data
if (Use_local_data) {
   if (!'results' %in% list.dirs(full.names=FALSE, recursive=FALSE)) stop('results directory not found!')
   if (!'data' %in% list.dirs(full.names=FALSE, recursive=FALSE)) stop('data directory not found!')
}
```

### 0.3 Plot on screen or save plots as pdfs?
Parts of this code take time to run, so if you want to go through examples fast you can specify
```{r}
Save_pdf=FALSE # Change to TRUE if you want to save pdf of figures.
```

## 1. Reconstruction of snowmelt from remote sensing data
We used NOAA CDR snow cover extent based on remote sensed data [Brown & Robinson 2011](#brown-robinson). Weekly snow cover data were downloaded on 24×24 km grid and subset by the _Limosa lapponica taimyrensis_ breeding range [Lappo et al. 2012](#lappo). Following code provided in [van Gils et al 2016](#van-gils), we extracted date 50% spring snow coverage as linearly interpolated time point at which mean snow cover first time in a year crossed 50%, results are presented in Extended Data Tab. 1.

### 1.1 Download publically available data
Load required packages
```{r}
library(ncdf4)
library(raster)
library(rgdal)
library(maptools)
```
Download taimyrensis bar-trailed godwit [(_Limosa lapponica taimyrensis_) range](#lappo) from this GitHub repo
```{r}
area.longlat<-readRDS(gzcon(url('https://git.io/vXRBz')))
```
Download and read in R all [snow data from NOAA](#brown-robinson)
```{r cache=TRUE} 
download.file('ftp://data.ncdc.noaa.gov/cdr/snowcover/nhsce_v01r01_19661004_20160905.nc',
               destfile='snow.nc', method="internal", mode="wb")
dat <- nc_open('snow.nc')
t <- ncvar_get(dat,'time') ## "days since 1966-10-03"
z <- ncvar_get(dat,'snow_cover_extent')
ylat <- ncvar_get(dat,'latitude')
xlon <- ncvar_get(dat,'longitude')

nc_close(dat)
```

### 1.2 Projection and raster extent
```{r}
lon <- raster(xlon)
lat <- raster(ylat)
snow <- brick(z)

start <- as.POSIXct("1966-10-03", "GMT")
  date <- start + ((t-6)*24*60*60)
```

### 1.3 Projection
```{r}
projSnow <- "+proj=stere +lat_0=90 +lon_0=10"
xy <- project(cbind(values(lon), values(lat)), projSnow)
area <- spTransform(area.longlat, CRS(projSnow))
```

### 1.4 Rasterize
```{r}
r <- raster(xmn = min(xy[,1]), xmx = max(xy[,1]), ymn = min(xy[,2]),
            ymx = max(xy[,2]), nrow=88, ncol=88)
tmp <- rasterize(xy, y = r, field = values(snow[[1]]))
plot(tmp)
data(wrld_simpl)
wrld <- spTransform(subset(wrld_simpl, NAME != "Antarctica"), CRS(projSnow))
plot(as(wrld, "SpatialLines"), add = TRUE, col = "red")

out <- data.frame(Date = date, Z = NA)
if (Run_everything) {
   # following loop takes ~ 20 minutes brt
   for(i in 1982:2016) {
      cat(round(i/length(names(snow)),4), "%   ", "\r")
      for(w in 1:length(date[as.numeric(format(date, "%Y"))==i])) {
         ind <- which(as.numeric(format(date, "%Y"))==i)[w]  
         tmp1 <- rasterize(xy, y = tmp, field = values(snow[[ind]]))
         tmp2 <- crop(tmp1, area) 
         tmp3 <- resample(tmp2, 
                      raster(extent(tmp2), ncol = 6, nrow = 12),
                      method = "ngb")
         out[ind,2] <- extract(tmp3, area, mean, na.rm=TRUE)
        }
   }
   saveRDS(out, file = "./results/snow.RDS")
} else {
   if (Use_local_data) {
      out<-readRDS('./results/snow.RDS')
   } else {
      out<-readRDS(gzcon(url("https://git.io/vXgZb")))
   }
}
```

### 1.5 Extract first date of 50% snowmelt
```{r}
out$zz<-out$Z-0.5
plot(Z~Date, data=subset(out, !is.na(Z)), type='l')
Index<-which(out$zz[-1]*out$zz[-length(out$zz)]<=0 & out$zz[-length(out$zz)]>=0)
Years_tmp<-unique(as.numeric(format(out$Date[Index], '%Y')))
#dates with last measurement
Dates_last<-as.POSIXct(sapply(Years_tmp, FUN=function(x) 
            out$Date[Index][as.numeric(format(out$Date[Index], "%Y")) == x ] [1]), origin='1970-01-01')
Index_last<-sapply(Years_tmp, FUN=function(x) 
            Index[as.numeric(format(out$Date[Index], "%Y")) == x ] [1])
Weight_second<-(out$Z[Index_last]-0.5)/(out$Z[Index_last] - out$Z[Index_last+1])
Weight_first<-1-Weight_second
Weighted_dates<-as.POSIXct(as.numeric(out$Date[Index_last])*Weight_first +
                as.numeric(out$Date[Index_last+1])*Weight_second, origin='1970-01-01')
Res<-data.frame(Year=Years_tmp, Date50=Weighted_dates)
Res$jdate50<-as.numeric(format(Res$Date50, '%j'))
plot(jdate50~Year, data=subset(Res))
summary(lm(jdate50~Year, data=subset(Res, Year>1995)))
Snow50<-Res
write.csv(Snow50, file='Snow50.RData', row.names=FALSE)
```

## 2. Arrival dates from citizen science data
We used data from citizen science project www.trektellen.nl and modelled them with approach similar to one used in Lindén & Mäntyniemi ([2011](#lindén-mäntyniemi)). Model was estimated with JAGS sampler ([Plummer 2003](#plummer)) via R2jags ([Su & Yahima 2015](#su-yahima)) interface from R.
_To run code from this chapter you need to install JAGS software._

### 2.1 Load packages and data
```{r}
library(R2jags)
if (Use_local_data) {
   sites_years_dates<-read.csv('./data/godwit_trektellen_seven_major_sites.csv', as.is=TRUE)
} else {
   sites_years_dates<-read.csv('https://git.io/vXEBH', as.is=TRUE)
}
```

### 2.2 Formulate model in JAGS language
```{r results='hide'}
sink("migration_model.jags") 
cat("
model {
    # Model
    for (Obs in 1:nObs) {    
      log(N[Obs])<-a0 + total_k[Year[Obs]] +
	  site_i[Site[Obs]]+Offset[Obs]-((Date[Obs]-
	  T_0k[Year[Obs]])^2)/(2*sigma[Year[Obs]]^2)-
	  0.9189385-log(sigma[Year[Obs]])
    }	
    #Priors
    for (k in 1:nYears) {
       total_k_src[k] ~ dnorm(0, 0.10)
       T_0k[k]~dnorm(125, 0.1)
       sigma[k]~dnorm(2, 0.1)T(0,)
    }
    for (i in 1:nSites) {
      site_i_src[i] ~ dnorm(0, 0.10) 
    }
    site_i  <- site_i_src[] -mean(site_i_src[])
    total_k <- total_k_src[]-mean(total_k_src[])
    a0 ~ dnorm(6, 0.1)
    r ~ dgamma(0.01,0.01)
    for (Obs in 1:nObs) { 
      p[Obs]<- r/(r+N[Obs])
    }
    #Likelihood
    for (Obs in 1:nObs) {
       Y[Obs]~dnegbin( p[Obs] , r )
    }
}",fill = TRUE)
sink()
```

### 2.3 Prepare data and initial values
```{r}
Data<-list('nObs'=nrow(sites_years_dates),
           'nYears'=length(unique(sites_years_dates$Year)),
           'nSites'=length(unique(sites_years_dates$Site)),
           'Year'=as.numeric(as.factor(sites_years_dates$Year)),
           'Site'=as.numeric(as.factor(sites_years_dates$Site)),
           'Date'=sites_years_dates$yday,
           'Offset'=log(sites_years_dates$Duration),
           'Y'=sites_years_dates$north)
nSites=length(unique(sites_years_dates$Site))
nYears=length(unique(sites_years_dates$Year))
inits=function() {list(
           'a0' =runif(1,3,10),
           'total_k_src'=rnorm(nYears, 0, 1), 
           'T_0k'=rnorm(nYears, 125, 2),
           'site_i_src'=log(plogis(rnorm(nSites, 0, 0.5))),
           'sigma'=rnorm(nYears, 8, 2))
}
jags.params=c("a0","total_k", "T_0k", "site_i", "sigma", "r")
```

### 2.4 Run the model
```{r}
if (Run_everything) {
   # following run takes ~ 5 minutes brt
   nchains<-parallel::detectCores()-1
   migration_model<-jags.parallel(data=Data, 
                  inits, 
                  parameters=jags.params, 
                  "migration_model.jags", 
                  n.chains = nchains, 
                  n.thin   = 3, 
                  n.iter   = 500, 
                  n.burnin = 200, 
                  working.directory = getwd())
   print(migration_model)
   saveRDS(migration_model, file='./results/migration_model.RDS')
} else {
   if (Use_local_data) {   
       migration_model<-readRDS('./results/migration_model.RDS')
   } else {
       migration_model<-readRDS(gzcon(url('https://git.io/vXgZG')))
   }
}
```

### 2.5 Look at the output
```{r results='hide'}
print(migration_model)
Arrivals<-data.frame(Yr=unique(sites_years_dates$Year), 
                     arrival=migration_model$BUGSoutput$mean$T_0k,
                     sigma=migration_model$BUGSoutput$mean$sigma)
write.csv(Arrivals, file="Arrivals_migration_model.csv", row.names=F)
```

## 3. Fuelling rates and their relationship with lugworm abundance

### 3.1 Estimate yearly arrival weights from Castricum data
```{r}
library(lme4)
if (Use_local_data) {
   Capture_data<-read.csv('./data/Capture_data.csv', as.is=TRUE)
} else {
   Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
}
Capture_data$date<-as.Date(Capture_data$date)

# arrival weight females
aggr_data_females<-subset(Capture_data, Sex==2 & Site == "Castricum")
Arrival_weight_females<-aggregate(aggr_data_females$Mass, 
                         by=list(aggr_data_females$Yr), FUN=mean)
names(Arrival_weight_females)  <-c("Yr", "Arr_Weight")
aggr_data_females$fYr<-as.factor(aggr_data_females$Yr)
weight_model_females<-lmer(Mass~-1+(1|fYr), data=aggr_data_females)
mu_W0_females<-coef(weight_model_females)$fYr[,1]
sigma2_W0_females<-var(residuals(weight_model_females))

# arrival weight males
aggr_data_males<-subset(Capture_data,  Sex==1 & Site == "Castricum")
Arrival_weight_males<-aggregate(aggr_data_males$Mass,
                         by=list(aggr_data_males$Yr), FUN=mean)
names(Arrival_weight_males)  <-c("Yr", "Arr_Weight")
aggr_data_males$fYr<-as.factor(aggr_data_males$Yr)
weight_model_males<-lmer(Mass~-1+(1|fYr), data=aggr_data_males)
mu_W0_males<-coef(weight_model_males)$fYr[,1]
sigma2_W0_males<-var(residuals(weight_model_males)) 

Arrival_weights<-data.frame(Yr=as.numeric(levels(aggr_data_females$fYr)),
                            Male_arrival_weight=mu_W0_males,
			    Female_arrival_weight=mu_W0_females)
write.csv(Arrival_weights, file='Arrival_weights.csv', row.names=FALSE)
```

### 3.2 Load packages and data
Here we load **arrival time** estimated in 2.5 data on lugworm densities in the Dutch Wadden Sea.
```{r}
library(R2jags)
if (Use_local_data) {
   Capture_data<-read.csv('./data/Capture_data.csv', as.is=TRUE)
   Arrivals<-read.csv('./results/Arrivals_migration_model.csv')
   Lugworms<-read.csv('./data/Lugworms.csv')
} else {
   Capture_data<-read.csv("https://git.io/vXEDL", as.is=TRUE)
   Arrivals<-read.csv('https://git.io/vXED0')
   Lugworms<-read.csv('https://git.io/vXESR')
}
   
Capture_data$date<-as.Date(Capture_data$date)
names(Arrivals)[2]<-"arrival_day"
Data_to_model<-merge(subset(Capture_data, Site!='Castricum'), Arrivals)
mu_T0<-Arrivals$arrival[Arrivals$Yr %in% unique(Data_to_model$Yr)]
sigma2_T0<-(Arrivals$sigma^2)[Arrivals$Yr %in% unique(Data_to_model$Yr)]

Lugworms_vec<-Lugworms[Lugworms$Yr %in% unique(Data_to_model$Yr),2]

```
### 3.3 Formulate model
```{r results='hide'}
sink("fuelling_model.jags")

cat("
    model {
    # prior
    for (i in 1:N) {    
       T0[i] ~ dnorm(mu_T0[i2k[i]], tau_T0[i2k[i], i2s[i]])
    }

    # Michaelins - Menten or functional response type II equation for fuelling on lugworms
    for(k in 1:K) {
       Alpha_t[k,1] ~ dnorm(((11*Lugworms[k])/(K_sat_m+Lugworms[k])),
	                         1/sigma2_alpha)
       Alpha_t[k,2] ~ dnorm(((13.2*Lugworms[k])/(K_sat_f+Lugworms[k])),
                             1/sigma2_alpha_fem)
    # 11 for males and 13.2 for females are fuelling maximum rates measured by Prokosch
	}

    # Likelihood
    for (i in 1:N) {
       Wt_mu[i] <- mu_W0[i2k[i],i2s[i]]+(Time[i]-T0[i])*(Alpha_t[i2k[i], i2s[i]])
       Wt[i] ~ dnorm(Wt_mu[i],Wt_tau[i2k[i], i2s[i]])
    }
  
    # params an hyper-priors
    for (k in 1:K) {
       for (s in 1:2) {
          Wt_s2[k,s] <- sigma2_W0[s]
          Wt_tau[k,s]<-1/Wt_s2[k,s]
       }
    }
    sigma2_alpha~dunif(0, 5)  
    sigma2_alpha_fem~dunif(0, 5)  
  
    K_sat_m~dunif(1, 20)
    K_sat_f~dunif(1, 20)
    
    for(k in 1:K) {
       tau_T0[k,1]<-1/(sigma2_T0[k]+sigma2_W0[1]/Alpha_t[k,1]) 
       tau_T0[k,2]<-1/(sigma2_T0[k]+sigma2_W0[2]/Alpha_t[k,2])
    }
}",fill = TRUE)
sink()
```

### 3.4 Prepare data and initial values
```{r}
Data=list(Wt=Data_to_model$Mass, Time=Data_to_model$yday,
          i2k=as.numeric(as.factor(Data_to_model$Yr)),
          i2s=Data_to_model$Sex, N=length(Data_to_model$Mass), 
	  K=length(unique(Data_to_model$Yr)),
	  mu_W0=cbind(mu_W0_males, mu_W0_females), 
	  sigma2_W0=c(sigma2_W0_males, sigma2_W0_females),
	  mu_T0=mu_T0,
	  sigma2_T0=sigma2_T0, Lugworms=Lugworms_vec)

inits=function() {
   list(sigma2_alpha=runif(1, 0, 5),
   sigma2_alpha_fem=runif(1, 0, 5),
   K_sat_m=runif(1, 1, 13),
   K_sat_f=runif(1, 1, 13))
}
jags.params=c("Alpha_t", "sigma2_alpha", "sigma2_alpha_fem", "K_sat_m", "K_sat_f")
```

### 3.5 Run the model
```{r}
if (Run_everything) {
   # following run takes ~ 5 minutes brt
   fuelling_model<- jags(data=Data, inits, parameters=jags.params,
                    "fuelling_model.jags", n.chains = 2, n.thin = 10,
		    n.iter = 10000, n.burnin = 1000, working.directory = getwd())
   saveRDS(fuelling_model, file='./results/fuelling_model.RDS')
} else {
   if (Use_local_data) {   
      fuelling_model<-readRDS('./results/fuelling_model.RDS')
   } else {
      fuelling_model<-readRDS(gzcon(url('https://git.io/vXgvv')))
   }
}
```

### 3.6 Explore and save model results
```{r results='hide'}
print(fuelling_model)
Years<-unique(as.numeric((Data_to_model$Yr)))
# save estimated slopes for survival model
Fuelling_slopes<-data.frame(Yr=Years,
         Fuelling_slope_males=fuelling_model$BUGSoutput$mean$Alpha_t[,1],
         Fuelling_slope_females=fuelling_model$BUGSoutput$mean$Alpha_t[,2],
         Fuelling_slope_males_predicted=11*Lugworms_vec/(fuelling_model$BUGSoutput$mean$K_sat_m+Lugworms_vec),
         Fuelling_slope_females_predicted=13.4*Lugworms_vec/(fuelling_model$BUGSoutput$mean$K_sat_f+Lugworms_vec))
write.csv(Fuelling_slopes, file='Fuelling_slopes.csv', row.names=FALSE)
```

### 3.7 Plot estimated fuelling slopes by lugworm abundance
```{r fig.width=10, fig.height=5}
time_scales<-abs(1-(Years-(min(Years)-1))/(max((Years-(min(Years)-1))+1)))
MyColor_palette<-colorRampPalette(c('#FC8D62', 'white'))
My_colors<-MyColor_palette(100)

if (Save_pdf) pdf('fueling rate.pdf', useDingbats=FALSE, width=10, height=10)

par(mfrow=c(1,2))
#-----------------------------
# males plot
plot(fuelling_model$BUGSoutput$mean$Alpha_t[,1]~Lugworms_vec,
     ylim=c(3.5,8.5),  ylab='fueling rate (g per day)',
     xlab='lugworm density, ind. per sq.m', main='Males',  las=1, type='n')
XX<-seq(min(Lugworms_vec), max(Lugworms_vec), 0.1)
Y_m<- t(sapply(XX, FUN=function(x) 
              quantile(x*11 /(x+fuelling_model$BUGSoutput$sims.list$K_sat_m),
	      probs=c(0.025, 0.5,0.975))))
lines(Y_m[,1]~XX, lty=2)
lines(Y_m[,2]~XX, lwd=2)
lines(Y_m[,3]~XX, lty=2)
for (i in 1:length(Lugworms_vec)) {
   points(fuelling_model$BUGSoutput$mean$Alpha_t[i,1]~Lugworms_vec[i],
   pch=21, cex=4, bg=My_colors[round(time_scales*100)][i], lwd=2)
   text(fuelling_model$BUGSoutput$mean$Alpha_t[i,1]~Lugworms_vec[i],
   labels = substr(Years[i],3,4))
}
box()
#-----------------
# females plot
plot(fuelling_model$BUGSoutput$mean$Alpha_t[,2]~Lugworms_vec,
     ylim=c(3.5,8.5),ylab='fueling rate (g per day)',
     xlab='lugworm density, ind. per sq.m', main='Females' ,las=1, type='n')
XX<-seq(min(Lugworms_vec), max(Lugworms_vec), 0.1)
Y_fem<- t(sapply(XX, FUN=function(x)
                 quantile(x*13.2 /(x+fuelling_model$BUGSoutput$sims.list$K_sat_f),
		 probs=c(0.025, 0.5,0.975))))
lines(Y_fem[,1]~XX, lty=1)
lines(Y_fem[,2]~XX, lwd=2)
lines(Y_fem[,3]~XX, lty=1)
for (i in 1:length(Lugworms_vec)) {
   points(fuelling_model$BUGSoutput$mean$Alpha_t[i,2]~Lugworms_vec[i],
   pch=21, cex=4, bg=My_colors[round(time_scales*100)][i], lwd=2)
   text(fuelling_model$BUGSoutput$mean$Alpha_t[i,2]~Lugworms_vec[i],
   labels = substr(Years[i],3,4))
}
box()
if (Save_pdf) dev.off()
```

## 4. Departure fuel load effects on survival from capture-recapture data
We used Cormack–Jolly–Seber (CJS) model ([Lebreton et al., 1992](#lebreton)) to model apparent survival independently from resighting probability. Set of nested models was estimated in program MARK ([White & Burnham, 1999](#white)) through RMark ([Laake, 2013](#laake)) interface.  To run model estimation with MARK or RMark you should first install program MARK from [here](http://www.phidot.org/software/mark/downloads).

### 4.1 Load and combine data
```{r}
library('RMark')
if (Use_local_data) {
   # a. load main CR data
   Full_CH<-read.csv('./data/Full_CH.csv', colClasses='character', row.names='code')
   # b. get arrivals to the Wadden Sea
   Arrivals_WS<-read.csv('./results/Arrivals_migration_model.csv')
   # c. get arrival weights
   Arrival_weights<-read.csv('./results/Arrival_weights.csv')
   # d. get annual slopes
   Fuelling_slopes<-read.csv('./results/Fuelling_slopes.csv')
   # e. get departures from Wadden Sea through arrival to Taimyr
   Arrival_Taimyr<-read.csv('./data/Arrivals_Khat.csv')
} else {
   # a. load main CR data
   Full_CH<-read.csv('https://git.io/vXEFF', colClasses='character', row.names='code')
   # b. get arrivals to the Wadden Sea
   Arrivals_WS<-read.csv('https://git.io/vXESW')
   # c. get arrival weights
   Arrival_weights<-read.csv('https://git.io/vXEbX')
   # d. get annual slopes
   Fuelling_slopes<-read.csv('https://git.io/vXEb5')
   # e. get departures from Wadden Sea through arrival to Taimyr
   Arrival_Taimyr<-read.csv('https://git.io/vXEbj')
}

Full_CH$SEX<-as.factor(Full_CH$SEX)
Full_CH$Rin_Place<-as.factor(Full_CH$ Rin_Place)

Departures_Wadden<-Arrival_Taimyr[,c(1,3)]
Departures_Wadden$yday<-Departures_Wadden$yday-4
names(Departures_Wadden)[2]<-'departure'

# f. now we combine all these measurements.
All_staging_data<-merge(merge(merge(Arrivals_WS[,1:2], 
                        Arrival_weights), Fuelling_slopes),Departures_Wadden)
All_staging_data$Departure_fuel_load_females<-All_staging_data$Fuelling_slope_females*
                                  (All_staging_data$departure-All_staging_data$arrival)
All_staging_data$Departure_fuel_load_females_predicted<-All_staging_data$Fuelling_slope_females_predicted*
                                  (All_staging_data$departure-All_staging_data$arrival)
All_staging_data$Departure_fuel_load_males<-All_staging_data$Fuelling_slope_males*
                                  (All_staging_data$departure-All_staging_data$arrival)
All_staging_data$Departure_fuel_load_males_predicted<-All_staging_data$Fuelling_slope_males_predicted*
                                  (All_staging_data$departure-All_staging_data$arrival)

Departure_Weight_gain_Females<-rbind(
    cbind(group='fCas', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_females, Departure_fuel_load_females_predicted))),
	cbind(group='fWad', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_females, Departure_fuel_load_females_predicted))))
names(Departure_Weight_gain_Females)[3]<-'Weight_gain'
names(Departure_Weight_gain_Females)[4]<-'Weight_gain_predicted'
Departure_Weight_gain_Males<- rbind(
	cbind(group='mCas', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_males, Departure_fuel_load_males_predicted))),
	cbind(group='mWad', subset(All_staging_data,
	select=c(Yr, Departure_fuel_load_males, Departure_fuel_load_males_predicted))))
names(Departure_Weight_gain_Males)[3]<-'Weight_gain'
names(Departure_Weight_gain_Males)[4]<-'Weight_gain_predicted'
Departure_Weight_gain<-rbind(Departure_Weight_gain_Females, Departure_Weight_gain_Males)
names(Departure_Weight_gain)[2]<-'time'
Departure_Weight_gain<-subset(Departure_Weight_gain, time>2000)
```

## 4.2 Prepare data in RMark
```{r}
Godwit.data<-process.data(Full_CH, model = "CJS", begin.time = 2001,
                          groups=c("SEX", "Rin_Place"))
Godwit.ddl<-make.design.data(Godwit.data, remove.unused = FALSE)
Godwit.ddl$Phi<-merge_design.covariates(Godwit.ddl$Phi, Departure_Weight_gain,
                                        bygroup=TRUE, bytime=TRUE)
# specify first year after marking birds
Godwit.ddl$Phi$two_plus=0
Godwit.ddl$Phi$two_plus[Godwit.ddl$Phi$Age>=1]=1
Godwit.ddl$p$two_plus=0
Godwit.ddl$p$two_plus[Godwit.ddl$p$Age>=1]=1

# we now scale and center weights by SEX
Godwit.ddl$Phi$Weight_gain_st<-NA
Godwit.ddl$Phi$Weight_gain_st[Godwit.ddl$Phi$SEX=='m']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain[Godwit.ddl$Phi$SEX=='m']))
Godwit.ddl$Phi$Weight_gain_st[Godwit.ddl$Phi$SEX=='f']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain[Godwit.ddl$Phi$SEX=='f']))

# we now scale and center predicted from stayover duration and lugworm abundance weights by SEX
Godwit.ddl$Phi$Weight_gain_pr_st<-NA
Godwit.ddl$Phi$Weight_gain_pr_st[Godwit.ddl$Phi$SEX=='m']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain_predicted[Godwit.ddl$Phi$SEX=='m']))
Godwit.ddl$Phi$Weight_gain_pr_st[Godwit.ddl$Phi$SEX=='f']<-
        scale(unique(Godwit.ddl$Phi$Weight_gain_predicted[Godwit.ddl$Phi$SEX=='f']))

# clean from previous runs in case there have been any
if (exists('cml')) {
   suppressWarnings(rm(list=cml[,1]))
   suppressWarnings(rm(list=cml[,2]))
} 
# specify model
# Survival part
Phi.weight_gain_pr=list(formula=~ Weight_gain_pr_st)	
Phi.TSM=list(formula=~two_plus)
Phi.SEX=list(formula=~SEX)
Phi.weight_gain.plus.TSM.plus.SEX=list(formula=~two_plus + Weight_gain_pr_st+SEX)
Phi.weight_gain_pr.plus.TSM=list(formula=~two_plus + Weight_gain_pr_st)
Phi.dot=list(formula=~1)
# Resighting part	
p.time.plus.place.plus.sex=list(formula=~time + Rin_Place+SEX)

cml=create.model.list("CJS")
```

### 4.3 Run MARK model
```{r}
if (Run_everything) {
   Res<-  mark.wrapper(cml, data=Godwit.data, ddl=Godwit.ddl, delete=FALSE, profile.int=F)
   saveRDS(Res, file='./results/survival_result.RDS')
} else {
   if (Use_local_data) {
      Res<-readRDS('./results/survival_result.RDS')
   } else {
   Res<-readRDS(gzcon(url('https://git.io/vXueC')))
   }
}
```

### 4.4 Median c-hat test in MARK
We now have to estimate potential overdispersion and correct for it. This possibility currently does not exist in RMark, so we export data to MARK and do test there. 
```{r results='hide'}
export.MARK(Godwit.data, 'godwit_data', Res, replace=TRUE)
```
>Estimated c-hat = 1.1445372 with sampling SE = 0.0037387
>95% Conf. Interval c-hat = 1.0882953 to 1.2007791

So we can adjust our response 
```{r}
Res_adj<-adjust.chat(Res, chat=1.1445372)
```

### 4.5 Prediction from the best model
```{r}
Model<-Res_adj[[6]]
Male_weight_pr<-Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad']
Male_weight_pr_sc<-scale(Male_weight_pr)
Male_weight_cov_sc<-seq(min(Male_weight_pr), max(Male_weight_pr), by=0.1)
Male_weight_cov_sc<-seq(-10, 10, by=0.1)

Female_weight_pr<-Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad']
Female_weight_pr_sc<-scale(Female_weight_pr)
Female_weight_cov_sc<-seq(min(Female_weight_pr_sc), max(Female_weight_pr_sc), by=0.1)
Female_weight_cov_sc<-seq(-10,10, by=0.1)

Design<-matrix(nrow=1, ncol=19, data=0)
Design[,1]<-1
Design[,2]<-1

Estimates_males<-c()
for (i in 1:length(Male_weight_cov_sc)) {
   Design[,3]<-Male_weight_cov_sc[i]
   Estimates_males<-rbind(Estimates_males, cbind(Male_weight_cov_sc=Male_weight_cov_sc[i],
                            get.real(Model, 'Phi', pim=FALSE, design=Design, se=T)[1,3:6]))
}
Estimates_males$Male_weight_cov<-Estimates_males$Male_weight_cov_sc*
                            attr(Male_weight_pr_sc,'scaled:scale') +
			    attr(Male_weight_pr_sc,'scaled:center') 

Design<-matrix(nrow=1, ncol=19, data=0)
Design[,1]<-1
Design[,2]<-1

Estimates_females<-c()
for (i in 1:length(Female_weight_cov_sc)) {
    Design[,3]<-Female_weight_cov_sc[i]
    Estimates_females<-rbind(Estimates_females, cbind(Female_weight_cov_sc=Female_weight_cov_sc[i],
                            get.real(Model, 'Phi', pim=FALSE, design=Design, se=T)[1,3:6]))
}
Estimates_females$Female_weight_cov<-Estimates_females$Female_weight_cov_sc*
                            attr(Female_weight_pr_sc,'scaled:scale') +
			    attr(Female_weight_pr_sc,'scaled:center') 
write.csv(Estimates_females, file='female_survival_prediction.csv', row.names=TRUE)
write.csv(Estimates_males, file='male_survival_prediction.csv', row.names=TRUE)
```

### 4.6 Plot survival over departure fuel load
```{r fig.width=10, fig.height=5}
if (Save_pdf) pdf('male_female_survival_over_fuel_load.pdf')

par(mfrow=c(1,2))
# Males
plot(estimate~Male_weight_cov, data=Estimates_males,  ylim=c(0.8, 0.95),
     ylab='Apparent Survival', xlab='Deposited fuel, g', las=1,
     xlim=range(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad']),
     type='n', main='Males')
lines(estimate~Male_weight_cov, data=subset(Estimates_males, Male_weight_cov>=
     min(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad']) &
     Male_weight_cov<=
     max(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad'])), lwd=2)
lines(ucl~Male_weight_cov, data=subset(Estimates_males, Male_weight_cov>=
     min(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad']) &
     Male_weight_cov<=
     max(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad'])), lwd=1)
lines(lcl~Male_weight_cov, data=subset(Estimates_males, Male_weight_cov>=
     min(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad']) &
     Male_weight_cov<=
     max(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='mWad'])), lty=1, lwd=1)

#  Females
plot(estimate~Female_weight_cov, data=Estimates_females,  ylim=c(0.8, 0.95),
     ylab='Apparent Survival', xlab='Deposited fuel, g', las=1,
     xlim=range(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad']),
     type='n', main='Females')
lines(estimate~Female_weight_cov, data=subset(Estimates_females, Female_weight_cov>=
     min(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad']) &
     Female_weight_cov<=
     max(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad'])), lwd=2)
lines(ucl~Female_weight_cov, data=subset(Estimates_females, Female_weight_cov>=
     min(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad']) &
     Female_weight_cov<=
     max(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad'])) , lwd=1)
lines(lcl~Female_weight_cov, data=subset(Estimates_females, Female_weight_cov>=
     min(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad']) &
     Female_weight_cov<=
     max(Departure_Weight_gain$Weight_gain_predicted[Departure_Weight_gain$group=='fWad'])), lty=1, lwd=1)
if (Save_pdf) dev.off()
```

## 5. Population trends from winter counts in Mauritania
We modelled change in total population of godwits in state space modelled suggested by Kéry & Shcaub ([2012](#kery-schaub)), but with negative binomial error distribution.

### 5.1 Load packages and data
```{r}
library(R2jags)
if (Use_local_data) {
   Counts<-read.csv('./data/Counts_Mauritania.csv')
} else {
   Counts<-read.csv('https://git.io/vXuL5')
}
Areas<-sort(unique(Counts$Area))
Years<-seq( min(unique(Counts$Yr)), max(unique(Counts$Yr)), 1)
y.matrix<-matrix(ncol=length(Areas), nrow= length(Years))
for (i in 1:nrow(Counts)) {
   y.matrix[which(Years==Counts$Yr[i]), which(Areas==Counts$Area[i])]<-Counts$Count[i]
}
```

### 5.2 Formulate model
```{r results='hide'}
sink("winter_counts_model.jags")
cat(" 
model {
   # priors
   for (s in 1:S) {N.est[1,s] ~ dexp(exp.lam)}
   mean.lambda ~ dunif(0.5,1.5)
   for (s in 1:S) {r[s] ~ dgamma(0.01, 0.01)}
   for (t in 1:T) {n_total[t]<-sum(N.est[t,])}

   #likelihood
   # state process 
   for (t in 1:(T-1)) {
      for (s in 1:S) {
         N.est[t+1,s] <- N.est[t,s]*mean.lambda
      }
   }
   # Observation process
   for (t in 1:T) {
      for (s in 1:S) {
         p[t,s]<-r[s]/(r[s]+N.est[t,s])
         y[t, s] ~ dnegbin(p[t,s], r[s])
      }
   }
}
", fill=TRUE)
sink()
```

### 5.3 Priors and initial values
```{r}
exp.mean<-mean(as.double(y.matrix),na.rm=T)
exp.lam <-1/exp.mean

jags.data<-list(y=y.matrix, T=length(Years), S=length(Areas), exp.lam=exp.lam)
   
# initials
inits<-function() {list(
        N.est=matrix(ncol=6, nrow=14, c(runif(6, 0, 15000), rep(NA, 6*14-6)), byrow=TRUE),
        mean.lambda=runif(1, 0.5,1.5),
        r=runif(6,0,10))}
jags.params=c("n_total", "mean.lambda", "r")
```

### 5.4 Run the model
```{r}
if (Run_everything) {
   # this model runs for ~ 2 mins brt
   Counts_model<- jags(data=jags.data, inits, parameters=jags.params,
   "winter_counts_model.jags", n.chains = 2, n.thin = 10, n.iter = 20000,
   n.burnin = 5000, working.directory = getwd())
   saveRDS(Counts_model, file='./results/Mauritania_counts_model.RDS')
} else {
   if (Use_local_data) {
      Counts_model<-readRDS('./results/Mauritania_counts_model.RDS')
   } else {
      Counts_model<-readRDS(gzcon(url('https://git.io/vXuqH')))
   }
}
```

### 5.5 Plot model results for panel C in Fig.1
```{r fig.width=5, fig.height=5, results='hide'}
print(Counts_model)
if (Save_pdf) pdf("Mauritania_counts.pdf", 5, 5)
Predicted_densities<-as.data.frame(cbind(Years, 
      t(apply(Counts_model$BUGSoutput$sims.list$n_total, 2,
      FUN=function(x) quantile(x, probs =c(0.025, 0.5, 0.975))))))
names(Predicted_densities)[2:4]<-c("lcl", "median","ucl")
plot(median~Years, data=Predicted_densities, ylim=range(Predicted_densities[,2:4]),
     type='n', las=1, ylab='')
Colors<-colorRampPalette(c("white", "#0072B2"))
polygon(x=c(Predicted_densities$Years, rev(Predicted_densities$Years)),
        y=c(Predicted_densities$lcl, rev(Predicted_densities$ucl)), col=Colors(5)[2], border=NA)
lines(median~Years, data=Predicted_densities, col='#0072B2', lwd=2)
points(rowSums(y.matrix)~ Years, pch='+', col='#0072B2', cex=2)
if (Save_pdf) dev.off()
```

## 6. Phenology plot (Fig. 1a)

### 6.1 Load data
```{r}
if (Use_local_data) {
   # read Snow
   Snow<-read.csv('./results/snow50.csv', as.is=TRUE)
   # read breeding data
   Nests<-read.csv('./data/Nests.csv', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('./data/Tipula.csv', as.is=TRUE)
   # read arrivals to Khatanga
   Arrivals_Khat<-read.csv('./data/Arrivals_Khat.csv', as.is=TRUE)
   # read arrivals to Wadden Sea (predicted by arrival model)
   Arr_Wadden<-read.csv('./results/Arrivals_migration_model.csv')
} else {
   # read Snow
   Snow<-read.csv('https://git.io/vXu3V', as.is=TRUE)
   # read breeding data
   Nests<-read.csv('https://git.io/vXu3y', as.is=TRUE)
   # read crane flies
   Tipula<-read.csv('https://git.io/vXu3x', as.is=TRUE)
   # read arrivals to Khatanga
   Arrivals_Khat<-read.csv('https://git.io/vXusf', as.is=TRUE)
   # read arrivals to Wadden Sea (predicted by arrival model)
   Arr_Wadden<-read.csv('https://git.io/vXED0')
}

names(Snow)<-c('Yr', 'Date', 'yday')
Snow$Date<-as.Date(Snow$Date, tz='GMT')
Nests$Date<-as.Date(Nests$Date, tz='GMT', format='%Y-%m-%d' )
Tipula$Date<-as.Date(Tipula$Date, tz='GMT', format='%Y-%m-%d' )
Arrivals_Khat$Date<-as.Date(Arrivals_Khat$Date, tz='GMT', format='%Y-%m-%d' )
names(Arr_Wadden)[2]<-'yday'
```

### 6.2 Estimate linear slopes of phenological events in time
```{r}
summary(lm(yday~Yr, data=subset(Snow, Yr %in% c(1994:2014))))
summary(lm(yday~Yr+Region, data=Tipula))
summary(lm(yday~Yr+Region, data=Nests))
summary(lm(yday~Yr, data=Arrivals_Khat))
summary(lm(yday~Yr, data=Arr_Wadden))
```

### 6.3 Plot the figure
```{r fig.width=5, fig.height=10}
if (Save_pdf) pdf('Taimyr_and_wadden.pdf', width=5, height=10, useDingbats=FALSE)
par(mar=c(4,4,2,6))
# snowmelt
plot(yday~Yr, data=Snow, type='n', ylim=c(115, 190), las=1, xlim=c(1993, 2015),axes=FALSE, ylab='')
axis(1)
box()
Snow<-subset(Snow, Yr %in% c(1992:2016))
polygon(y=c(Snow$yday, rep(200, length(Snow$yday))), 
        x=c(Snow$Yr, rev(Snow$Yr)),  pch=21, cex=4, 
	bg=grey(0.5), lwd=2, col='#bae4bc', border='#7bccc4')
# time lines
abline(h=121, col=grey(0.5))
abline(h=152, col=grey(0.5))
abline(h=182, col=grey(0.5))
abline(h=121+15, col=grey(0.5), lty=2)
abline(h=152+15, col=grey(0.5), lty=2)
# and lables for them
par(xpd=TRUE)
text(y=121, x=2019, '1 May')
text(y=152, x=2019, '1 June')
text(y=182, x=2019, '1 July')
par(xpd=FALSE)
# snow
abline(lm(yday~Yr, data=subset(Snow, Yr %in% c(1994:2015))), col='#7bccc4', lwd=2)
# tipula
points(yday~Yr, data=Tipula, pch=21, bg='#33a02c', lwd=1, cex=2, col=NULL )
lm_tipula<-lm(yday~Yr+Region, data=Tipula)
lines(predict(lm_tipula, newdata=data.frame(Yr=c(1992,2016), Region='South'))~
              c(1992,2016),lwd=2, col='#33a02c')
lines(predict(lm_tipula, newdata=data.frame(Yr=c((2004-0.5):(2007+0.5)), Region='North'))~
              c((2004-0.5):(2007+0.5)), lwd=2, col='#33a02c', lty=2)
# nests
points(yday~Yr, data=Nests, pch='+', cex=2,  lwd=1, col='#cc79a7')
lm_nests<-lm(yday~Yr+Region, data=Nests)
lines(predict(lm_nests, newdata=data.frame(Yr=c(1992,2016), Region='South'))~
              c(1992,2016), lwd=2, col='#cc79a7')
lines(predict(lm_nests, newdata=data.frame(Yr=c((2004-0.5):(2007+0.5)), Region='North'))~
              c((2004-0.5):(2007+0.5)), lwd=2, col='#cc79a7', lty=2)
# Khat arrivals
abline(lm(yday~Yr, data=Arrivals_Khat),col='#E69F00', lwd=2)
points(yday~Yr, data=Arrivals_Khat,  pch=21, cex=2, bg='#E69F00', lwd=1, col=NULL)
# Wadden arrivals..
Width=0.25
Arrivals_Khat$Departure<-Arrivals_Khat$yday-4
Stayovers<-merge(Arr_Wadden, Arrivals_Khat[,-which(names(Arrivals_Khat)=='yday')], by='Yr')
Stayovers$Stayover<- Stayovers$Departure- Stayovers$yday
Stayovers$time_scales<-abs(1-(Stayovers$Yr-(min(Stayovers$Yr)-1))/
                       (max((Stayovers$Yr-(min(Stayovers$Yr)-1))+1)))
MyColor_palette<-colorRampPalette(c('#FC8D62', 'white'))
My_colors<-MyColor_palette(100)
rect(xleft=Stayovers$Yr-Width, xright=Stayovers$Yr+Width, 
     ybottom=Stayovers$yday, ytop=Stayovers$Departure, 
     border=NA, col=My_colors[round(Stayovers$time_scales*100)])
abline(lm(yday~Yr, data=Arr_Wadden), col='#FC8D62', lwd=2)
points(yday~Yr, data=Arr_Wadden, bg='#FC8D62', pch=23, cex=2, col=grey(0.9))
box()
if (Save_pdf) dev.off()
```

## 7. Stayover duration - lugworms - godwit survival (Fig. 2)

### 7.1 Load data
```{r}
if (Use_local_data) {
   fuelling_model<-readRDS('./results/fuelling_model.RDS')
   Estimates_females<-read.csv(file='./results/female_survival_prediction.csv')
   # read arrivals to Wadden Sea (predicted by arrival model)
   Arr_Wadden<-read.csv(file='./results/Arrivals_migration_model.csv')   
   Lugworms<-read.csv('.data/Lugworms.csv')
   Estimates_females<-read.csv(file='./results/female_survival_prediction.csv')
} else {
   fuelling_model<-readRDS(gzcon(url('https://git.io/vXgvv')))
   Estimates_females<-read.csv(file='https://git.io/vXgvd')
   # read arrivals to Wadden Sea (predicted by arrival model)
   Arr_Wadden<-read.csv('https://git.io/vXED0')   
   Lugworms<-read.csv('https://git.io/vXESR')
   Estimates_females<-read.csv(file='https://git.io/vXgvd')
}
```

### 7.2 Prepare data
```{r}
   Arrivals_Khat$Date<-as.Date(Arrivals_Khat$Date, tz='GMT', format='%Y-%m-%d' )
   Arrivals_Khat$Departure<-Arrivals_Khat$yday-4
   names(Arr_Wadden)[2]<-'yday'
   Stayovers<-merge(Arr_Wadden, Arrivals_Khat[,-which(names(Arrivals_Khat)=='yday')], by='Yr')
   Stayovers$Stayover<- Stayovers$Departure- Stayovers$yday
   Stayovers$time_scales<-abs(1-(Stayovers$Yr-(min(Stayovers$Yr)-1))/
                             (max((Stayovers$Yr-(min(Stayovers$Yr)-1))+1)))
   Stayovers<-merge(Stayovers, Lugworms)
```
Create grid for prediction
```{r}
XY<-expand.grid(Lugworm_density=seq(5,33, 0.1), stayover=seq(17,37, 0.1))
```
now for every of these points I get estimate of fueling slope, that I will combine with the stayover
```{r}
x=XY[,1]
a<-sapply(x, FUN=function(x) quantile(x*13.2/(fuelling_model$BUGSoutput$sims.list$K_sat_f + x),
                             probs =c(0.025, 0.5, 0.975)))
XY$Female_Median_Slope<-a[2,]
XY$Female_lcl_Slope<-a[1,]
XY$Female_ucl_Slope<-a[3,]
```
Estimate weight gain from slopes and stayovers
```{r}
XY$Slope_Weight_gain_Females<-XY$Female_Median_Slope * XY$stayover
XY$Phi_females<-approx(x=Estimates_females$Female_weight_cov,
                       y = Estimates_females$estimate, XY$Slope_Weight_gain_Females)$y

```

### 7.3 Plot
```{r fig.width=10, fig.height=10}

if (Save_pdf) pdf(file='Figure 2_4 graphs.pdf', useDingbats=FALSE, width=10, height=10)

par(mfrow=c(2,2))
par(mar=c(3, 6,4,1 ))
# set up colors
Late_color<-'#CD6632'
Early_color<-'#6FC067'

#-------------------------------------
# Panel a - stayover change over years
plot(Stayovers$Stayover~Stayovers$Yr, type='n', ylim=c(17, 37),  ylab='',
     las=1, xlim=c(1993, 2016), xlab='', cex=1.5, axes=F, yaxs='i')
axis(1, cex.axis=1.5)

par(xpd=TRUE)
mtext(side=1, 'Year', line=3, cex=1.5)
par(xpd=FALSE)

axis(4, labels=FALSE)
mtext(side=2, 'fuelling time (days)', line=1,cex=1.5,)
abline(lm(Stayover~Yr, data=Stayovers), lwd=2)

MyColor_palette<-colorRampPalette(c('#FC8D62', 'white'))
My_colors<-MyColor_palette(100)

#Horizontal lines with specific colors
abline(h=predict(lm(Stayover~Yr, data=Stayovers), 
                 newdata=data.frame(Yr=c(2015))), lwd=2, col=Late_color)
abline(v=2015, lwd=2, col=Late_color)

abline(h=predict(lm(Stayover~Yr, data=Stayovers),
                 newdata=data.frame(Yr=c(1995))), lwd=2, col=Early_color)
abline(v=1995, lwd=2, col=Early_color)
# 
for (i in 1:nrow(Stayovers)) {
   points(Stayover~Yr, data=Stayovers[i,], pch=21, cex=4,
          bg=My_colors[round(Stayovers[i,]$time_scales*100)], lwd=2)
   text(Stayover~Yr, data=Stayovers[i,], labels = substr(Yr,3,4))
}
box()

#-------------------------------------
# Panel b survival surface

Colors<-colorRampPalette(c("#b2182b",
                           "#d6604d",
                           "#f4a582",
                           "#fddbc7",
                           "#f7f7f7",
                           "#d1e5f0",
                           "#92c5de",
                           "#4393c3",
                           "#2166ac"), bias=0.5)

par(mar=c(3, 2,4,3))
library(fields)
image.plot(as.image(x=XY[1:2], Z=XY$Phi_females, nx=200, ny=200), 
          col=Colors(256), xlab='', ylab='', las=1, ylim=c(17,37),
	  legend.mar=7, cex.axis=1.5, legend.cex=1.5)
Females_slope_average<-approx(x=XY$Lugworm_density, y=XY$Female_Median_Slope, mean(Stayovers$lugworms_ad) )$y
Females_weight_gain_before<-predict(lm(Stayover~Yr, data=Stayovers), newdata=data.frame(Yr=c(1995))) *
                            Females_slope_average
Females_average_survival<-approx(x=Estimates_females$Female_weight_cov,
                                 y = Estimates_females$estimate, Females_weight_gain_before)$y

contour(as.image(x=XY[1:2], Z=XY$Phi_females),add=T, levels=Females_average_survival,
        lwd=3, col=grey(0.1), labels=round(Females_average_survival,2), labcex=1)
contour(as.image(x=XY[1:2], Z=XY$Phi_females),add=T, levels=c(0.8, 0.85, 0.95), col=grey(0.5), labcex=1)

abline(h=predict(lm(Stayover~Yr, data=Stayovers), newdata=data.frame(Yr=c(2015))), lwd=2, col=Late_color)
abline(v=25.1, col=Late_color, lwd=2)
abline(h=predict(lm(Stayover~Yr, data=Stayovers), newdata=data.frame(Yr=c(1995))), lwd=2, col=Early_color)
abline(v=mean(Stayovers$lugworms_ad), col=Early_color, lwd=2)

for (i in 1:nrow(Stayovers)){
   points(Stayover~lugworms_ad, data=Stayovers[i,], pch=21, cex=4,
          bg=My_colors[round(Stayovers$time_scales[i]*100)], lwd=2)
   text(Stayover~lugworms_ad, data=Stayovers[i,], labels = substr(Yr,3,4))
}
box()
frame() # for empty frame

#---------------------------------------------
#Panel c - lugworm densities
par(mar=c(15,2,0,5 ))

# histogram of lugworm abundance
hist(Lugworms$lugworms_ad, main='', xlab='', ylab='n years', las=1, col=grey(0.9),
     breaks=10, axes=FALSE, xaxs='i', xlim=range(XY[1]))
axis(2, cex.axis=1.5, las=1)
axis(3, labels=FALSE)
hist(Stayovers$lugworms_ad, xlim =c(5,34), main='', xlab='', ylab='n years', las=1,
     add=TRUE, col='#6FC067')
abline(v=mean(Stayovers$lugworms_ad), lwd=2, col=Early_color)
abline(v=25.1,  lwd=2, col=Late_color)
box()
mtext(side=2, 'n Years', line=3, cex=1.5)
mtext(side=1, 'Lugworm density', line=1, cex=1.5)

if (Save_pdf) dev.off()
```

## References

1. Brown, R. D. & Robinson, D. A. Northern Hemisphere spring snow cover variability and change over 1922-2010 including an assessment of uncertainty. The Cryosphere 5, 219-229 (2011).<a id="brown-robinson"></a>
1. Lappo, E., Tomkovich, P. & Syroechkovskiy, E. Atlas of breeding waders in the Russian Arctic. (2012).<a id="lappo"></a>
1. van Gils, J. A. et al. Body shrinkage due to Arctic warming reduces red knot fitness in tropical wintering range. Science 352, 819-821 (2016).<a id="van-gils"></a>
1. Lindén, A. & Mäntyniemi, S. Using the negative binomial distribution to model overdispersion in ecological count data. Ecology 92, 1414-1421 (2011).<a id="lindén-mäntyniemi"></a>
1. Plummer, M. JAGS: A program for analysis of Bayesian graphical models using Gibbs sampling. (2003).<a id="plummer"></a>
1. Su, Y.-S. & Masanao Yajima. R2jags: Using R to Run 'JAGS'. (2015).<a id="su-yahima"></a>
1. Lebreton, J.-D., Burnham, K. P., Clobert, J. & Anderson, D. R. Modeling survival and testing biological hypotheses using marked animals: a unified approach with case studies. Ecol. Monogr. 62, 67-118 (1992).<a id="lebreton"></a>
1. White, G. C. & Burnham, K. P. Program MARK: survival estimation from populations of marked animals. Bird Study 46, S120-S139 (1999).<a id="white"></a>
1. Laake, J. L. RMark: An R interface for analysis of capture-recapture data with MARK. 25 (Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv., 2013).<a id="laake"></a>
1. Kéry, M. & Schaub, M. Bayesian population analysis using WinBUGS a hierarchical perspective. (Academic Press, 2012).<a id="kery-schaub"></a>

P.S. The html file from this markdown can be recereated with folloing code
```{r eval=FALSE}
download.file('https://git.io/vXaM6', 'tmp.rmd')
rmarkdown::render('tmp.rmd', output_format = 'html_document',
        output_options=list(toc=TRUE, toc_float=list(collapsed=FALSE)), 
		encoding='utf-8')
```
